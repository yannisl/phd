% \iffalse meta-comment
%<*internal>
\iffalse
%</internal>
%<*readme>
----------------------------------------------------------------
phd-pkgmanager --- a package to shorten preambles
E-mail: yannislaz@gmail.com
Released under the LaTeX Project Public License v1.3c or later
See http://www.latex-project.org/lppl.txt
----------------------------------------------------------------
This file provides a phd for defining a class.
%</readme>
%<*readmemd>
###The `phd` LaTeX2e package

The `phd` latex package and the class with the same name provide
convenient methods to create new styles for books, reports
and articles. It also loads the most commonly used packages 
and resolves conflicts.

This work consists of the file  `phd.dtx`,
and the derived files   `phd.ins`,  `phd.pdf`, and `phd.sty`.

###Installation

run
          phd-lua.bat on windows
           pdflatex phd.dtx
           makeindex -s gind.ist -g phd 

If you have any difficulties with the package come and join us at
http://tex.stackexchange.com and post a new question or
add a comment at http://tex.stackexchange.com/a/45023/963.
or send me a message at  yannislaz at gmail.com

### Documentation

The package was written using the `doc` and `docscript` packages,
so that it is self documented in a literary programming style. 
The .pdf is a fat document, providing over fifty book styles (the
equivalent of classes) plus there is a lot of write-up on the inner
workings of TeX and LaTeX2e. However, you don't need to know much
to use it.

      \usepackage{phd}
      \input{style13}

All choices, are made via an extended key-value interface. 
Although not a compliment, it resembles CSS and the keys are a bit verbose but
attributes are easy to change and have a consistent and easy to remember interface.

To set or add a key we only use one command:

      \cxset{chapter name font-size = Huge,
             chapter number font-size = HUGE} 

### Future Development

This is still an experimental version, but I will retain the
interface in future releases. There is a large amount of
work still to be carried out to improve the template styles
provided, to test it more thoroughly and to add a number of
improvements in the special designs. At present I estimate
that I have completed about 70% of the work that needs
to be done.

__The package as it stands is not production stable.__ 


%</readmemd>
%
%<*TODO>
1. On final round add pkg options. This was left as last in order not to solve problems by adding
    options. Too many options are not a good User Interface.
2.  Finish symbol management, both text and math. Math already 60% incorporated.
3.  Better integration of indexing commands.   
4.  Revisit layout manager for Chapters. Broke again in tests.
5.  Docs. Add all references.
6.  Incorporate phd class for more flexibility.
7. Improve package manager.
8. Group script loading for better font management.
9. General font management to relook it again.
10. Add all style sections (about 100 already prepared). Once they
     are all working issue beta version.
%</TODO>
%<*internal>
\fi
\def\nameofplainTeX{plain}
\ifx\fmtname\nameofplainTeX\else
  \expandafter\begingroup
\fi
%</internal>
%<*install>
\input docstrip.tex
\keepsilent
\askforoverwritefalse
\preamble
----------------------------------------------------------------
phd --- A package to beautify documents.
E-mail: yannislaz@gmail.com
Released under the LaTeX Project Public License v1.3c or later
See http://www.latex-project.org/lppl.txt
----------------------------------------------------------------
\endpreamble

%\BaseDirectory{C:/users/admin/my documents/github/phd}
%\usedir{MWE}
\generate{\file{\jobname.sty}{
  \from{\jobname.dtx}{LSECT}}
  }

%\nopreamble\nopostamble

%</install>

%<install>\endbatchfile
%<*internal>
%\usedir{tex/latex/phd}
\generate{
  \file{\jobname.ins}{\from{\jobname.dtx}{install}}
}
\nopreamble\nopostamble

\generate{
	\file{README.txt}{\from{\jobname.dtx}{readme}}
  }

\generate{
  \file{README.md}{\from{\jobname.dtx}{readmemd}}
}
\generate{
  \file{TODO.tex}{\from{\jobname.dtx}{TODO}}
}

\ifx\fmtname\nameofplainTeX
  \expandafter\endbatchfile
\else
  \expandafter\endgroup
\fi
%</internal>
%<*driver>

%\listfiles
%gdef\@onlypreamble{} % TO BE REMOVED NEEDED FOR TUTS
\documentclass[oneside,11pt,a4paper]{ltxdoc}
\usepackage[bottom=2cm]{geometry}
\savegeometry{std}
% \usepackage[style=mla]{biblatex}
\usepackage{phd}
\usepackage{phd-lowersections}
%\usepackage{pkgindoc}             %%% danger
\sethyperref

\begin{filecontents}{defaults-chapters}
%\cxset{chapter shadow = drop shadow,
%       chapter font-size = Huge,
%       section shadow = no shadow,
%       chapter background-color=white,
%       chapter title font-size=Huge}
 \cxset{    
    chapter number font-size       = huge,
    chapter number font-weight     = bfseries,
    chapter number font-family     = sffamily,
    chapter number font-shape      = upshape,
    chapter number align           = Centering,
    }
\cxset{%    
     chapter title font-size        = huge,
     chapter title font-weight      = bold,
     chapter title font-family      = sffamily,
     chapter title font-shape       = upshape,
     }   
\cxset{%    
    chapter title margin-top       = 0cm,
    chapter title margin-right     = 1cm,
    chapter align                  = RaggedLeft,
    chapter title align            = Centering, %checked
    chapter name                   = Section,
    chapter format                 = block,
    chapter font-size              = huge,
    chapter font-weight            = bold,
    chapter font-family            = sffamily,
    chapter font-shape             = upshape,
    chapter color                  = spot!30,
    chapter number prefix          = ,
    chapter number suffix          = ,
    chapter numbering              = arabic,
    chapter indent                 = 0pt,
    chapter beforeskip             = -1sp,
    chapter afterskip              = 30pt,
    chapter afterindent            = off,
    chapter number after           = ,
    chapter arc                    = 3pt,
    chapter background-color       = spot!30,
    chapter afterindent            = off,
    chapter grow left              = 0mm,
    chapter grow right             = 0mm,
    chapter rounded corners        = northeast,
    chapter shadow                 = drop shadow,
    chapter border-left-width      = 0pt,
    chapter border-right-width     = 0pt,
    chapter border-top-width       = 2pt,
    chapter border-bottom-width    = 2pt,
    chapter padding-left-width     = 0pt,
    chapter padding-right-width    = 10pt,
    chapter padding-top-width      = 10pt,
    chapter padding-bottom-width   = 10pt,
    chapter number color           = spot!30    
    chapter title color            = spot!30}
\end{filecontents}
\input{defaults-chapters}  
\begin{document}
%\coverpage{asia}{Book Design }{Camel Press}{HEADINGS}{DESIGN} 
\pagestyle{empty}
\coverpage{habtoor-city}{Delay Claim}{HLS-DSE/JV}{HABTOOR CITY}{MEP CLAIM} 
\secondpage
\pagestyle{empty}
\clearpage

\tableofcontents
\pagestyle{empty}
\setcounter{secnumdepth}{2}
\parskip0pt
\mainmatter
\pagenumbering{arabic}
\pagestyle{myheadings}        
%       
%\input{./mep/claim}  
%\input{./mep/dewa} 
%\input{./mep/busbar}
%\input{./mep/disruption}
%\input{./mep/RFI-mechanical}
%\input{./mep/RFI-electrical}
%%\input{./mep/internal}
%\input{./mep/provisional-sums}
%\input{./sections/introduction}
%
%\input{./styles/style01}
%\input{./styles/style02}
%\input{./styles/style03}
%\input{./styles/style04}
%\input{./styles/style05}
\input{./sections/lowerlevelheadings}
\makeatletter
\@debugtrue
\makeatother
\DocInput{\jobname.dtx}
\input{test-sectioning}
% \printindex
 %
% 
\end{document}
%</driver>
% \fi
% 
%  \CheckSum{0}
%  \CharacterTable
%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%   Digits        \0\1\2\3\4\5\6\7\8\9
%   Exclamation   \!     Double quote  \"     Hash (number) \#
%   Dollar        \$     Percent       \%     Ampersand     \&
%   Acute accent  \'     Left paren    \(     Right paren   \)
%   Asterisk      \*     Plus          \+     Comma         \,
%   Minus         \-     Point         \.     Solidus       \/
%   Colon         \:     Semicolon     \;     Less than     \<
%   Equals        \=     Greater than  \>     Question mark \?
%   Commercial at \@     Left bracket  \[     Backslash     \\
%   Right bracket \]     Circumflex    \^     Underscore    \_
%   Grave accent  \`     Left brace    \{     Vertical bar  \|
%   Right brace   \}     Tilde         \~}
%
%
%
% \changes{1.0}{2013/01/26}{Converted to DTX file}
%
% \DoNotIndex{\newcommand,\newenvironment}
% \GetFileInfo{phd.dtx}
% 
%  \def\fileversion{v1.0}          
%  \def\filedate{2012/03/06}
% \title{The \textsf{phd} package.
% \thanks{This
%        file (\texttt{phd.dtx}) has version number \fileversion, last revised
%        \filedate.}
% }
% \author{Dr. Yiannis Lazarides \\ \url{yannislaz@gmail.com}}
% \date{\filedate}
%
%
% 
% ^^A\maketitle
% 
% ^^A\frontmatter
%  ^^A\coverpage{./images/hine02.jpg}{Book Design }{Camel Press}{}{}
%  \newpage
% ^^A\secondpage
% \pagestyle{empty}
%
%
% 
%
%
% \pagestyle{headings}
% \raggedbottom
%  \OnlyDescription
%
%  \StopEventually{\printindex}

% \CodelineNumbered
% \pagestyle{headings}
% 
%<*LSECT>
% \part{IMPLEMENTATION}
% 
% \cxset{chapter title margin-top=12pt,
%        chapter beforeskip=-1sp,
%        chapter title color=thegray,
%        chapter number color=blue }
% \chapter{Code Implementation Objectives and Strategy}
% 
% 
%
% The original sectioning routines of the \latexe source are somewhat complicated by the
% way optional commands were build. With expl3's xparse module these type of multi-switch commands can be simplified and the code made clearer.
% 
% The aim of this package is to provide:
% \begin{enumerate}
% \item An extended key value interface to lower level sectioning functions.

% \item To provide a compatibility mode, where documents wishing to test the package
% can have an easy switch to switch in and out. This is also important for the testing of the package.

% \item To provide a number of pre-canned templates that cover most of the typical use case.

% \item To provide means for a plug-in architecture for extensions.
% \end{enumerate}
% 
%
% \section{Preliminaries}
%
%  Standard file identification. We first announce the package 
%	 and require that it be used with \LaTeX2e. 
%
%  \lorem
%
%    \begin{macrocode}
\NeedsTeXFormat{LaTeX2e}[1994/12/01]%
\ProvidesFile{phd-lowersections}[2015/1/13 v1.0 less preamble (YL)]%
%    \end{macrocode}
%
% \cxset{section format=hang}
% \section{Source2e Interface}
% 
% I am not very fond of mixing expl3 control sequences with source2e commands. Here
% we provide an interface for all these commands we might use. 
% This section can be revisited once expl3 code becomes available.
%
%    \begin{macrocode}
\let\ltxtoday\today
\newif\if@ltxcompat \@ltxcompatfalse
%
\newcommand\tikzi[1][after heading] {
   %\if@debug
    \tikz[remember picture,overlay] 
    \draw[<->] (0,0)--(0,.2)--++(-.5,0) node[left,fill=blue!15,text=black]%
       {{\ttfamily\footnotesize #1}};%\space%
   %\fi    
  }
%    \end{macrocode}
%
% \section{Key Management}
%
% This part of the code is a bit verbose. We care to provide keys for all
% parameters in order to allow flexibility and easy extensions.
%
% \subsection{Sections}
%    \begin{macrocode}
\ExplSyntaxOn
\def\l_phd_subsection_number_prefix_tl {}
\def\l_phd_subsection_number_suffix_tl {}
\def\l_phd_subsubsection_number_prefix_tl{}
\def\l_phd_subsubsection_number_suffix_tl{}
\def\l_phd_paragraph_number_prefix_tl{}
\def\l_phd_paragraph_number_suffix_tl{}
\def\l_phd_subparagraph_number_prefix_tl{}
\def\l_phd_subparagraph_number_suffix_tl{}
\clist_new:N \phd_book_divisions_clist
\clist_gset:Nn \phd_book_divisions_clist
  {
    chapter,section,subsection,subsubsection,
    paragraph,subparagraph
  }

\dim_gzero_new:N \l_phd_section_title_border_left_width_dim

%    \end{macrocode}
% \begin{docCommand} {phd_create_new_primary_element:nn} { \marg{label}}
%  Creates new dims for primary elements. The label is one of chapter, section
%  etc. 
% \end{docCommand}
%    \begin{macrocode}
\cs_new:Npn \phd_create_new_element:nn #1 #2 #3
  {
    \dim_gzero_new:c {l_phd_#1#2_#3_top_width_dim} %margin
    \dim_gzero_new:c {l_phd_#1#2_#3_right_width_dim}
    \dim_gzero_new:c {l_phd_#1#2_#3_bottom_width_dim}
    \dim_gzero_new:c {l_phd_#1#2_#3_left_width_dim}
 }

\cs_new:Npn \phd_create_new_element_auxiliary:nn #1 
  {
     \phd_create_new_element:nn {#1} {} {margin}
     \phd_create_new_element:nn {#1} {} {padding}
     \phd_create_new_element:nn {#1} {} {border}
     \phd_create_new_element:nn {#1} {title} {margin}
     \phd_create_new_element:nn {#1} {title} {padding}
     \phd_create_new_element:nn {#1} {title} {border}
  }
  
\clist_map_inline:Nn \phd_book_divisions_clist
  {
     \phd_create_new_element:nn {#1} {} {margin}
     \phd_create_new_element:nn {#1} {} {padding}
     \phd_create_new_element:nn {#1} {} {border}
     \phd_create_new_element:nn {#1} {_title} {margin}
     \phd_create_new_element:nn {#1} {_title} {padding}
     \phd_create_new_element:nn {#1} {_title} {border}
  }
 
\cs_new:Npn \printproperties
  {
    \input{debug-dims}  
  }    
\ExplSyntaxOff  
%    \endmacrocode}
% 
% 
%    \begin{macrocode}
\ExplSyntaxOn
\def\makekeys#1
 {
  \cxset
    {
% Main elements names etc
     #1~name/.code                 = \cs_gset:cpn {#1name} {##1}, 
     #1~beforeskip/.code           = \cs_gset:cpn {l_phd_#1_before_skip_tl}{##1},
     #1~afterskip/.code            = \cs_gset:cpn {l_phd_#1_after_skip_tl}{##1},
     #1~indent/.code               = \cs_gset:cpn {l_phd_#1_indent_tl}{##1},
% fonts
     #1~font-size/.fontsize        = l_phd_#1_fontsize_tl,
     #1~font-weight/.fontweight    = l_phd_#1_fontweight_tl, 
     #1~font-shape/.fontstyle      = l_phd_#1_fontshape_tl,  
     #1~font-family/.fontfamily    = l_phd_#1_fontfamily_tl,   
% Format
     #1~format/.format~in          = l_phd_#1_format_tl,   
% Colors
     #1~background-color/.colorin  =  l_phd_#1_background_color_tl,
     #1~color/.colorin             =  l_phd_#1_color_tl, 
     #1~shadow/.code               = \cs_gset:cpn {l_phd_#1_shadow_tl}{drop~shadow},
% Main text alignment
     #1~align/.textalign           = l_phd_#1_align_tl,   
% Rounded boxes
     #1~arc/.code                  = \cs_gset:cpn {l_phd_#1_arc_tl} {##1},
     #1~grow~left/.code            = \cs_gset:cpn {l_phd_#1_grow_left_dim}{##1},
     #1~grow~right/.code           = \cs_gset:cpn {l_phd_#1_grow_right_dim}{##1},
     #1~rounded~corners/.code      = \cs_gset:cpn {l_phd_#1_rounded_corners_tl}{##1},
% afterindent     
     #1~afterindent/.onoff         = {afterindent@cx},           
% Main element borders
     #1~border-top-width/.code     = \dim_set:cn {l_phd_#1_border_top_width_dim}    {##1},  
     #1~border-right-width/.code   = \dim_set:cn {l_phd_#1_border_right_width_dim}  {##1}, 
     #1~border-bottom-width/.code  = \dim_set:cn {l_phd_#1_border_bottom_width_dim} {##1},  
     #1~border-left-width/.code    = \dim_set:cn {l_phd_#1_border_left_width_dim}   {##1}, 
% 
     #1~padding-top-width/.code    = \dim_set:cn {l_phd_#1_padding_top_width_dim}    {##1},  
     #1~padding-right-width/.code  = \dim_set:cn {l_phd_#1_padding_right_width_dim}  {##1}, 
     #1~padding-bottom-width/.code = \dim_set:cn {l_phd_#1_padding_bottom_width_dim} {##1},  
     #1~padding-left-width/.code   = \dim_set:cn {l_phd_#1_padding_left_width_dim}   {##1}, 
%         
     #1~margin-top-width/.code     = \dim_set:cn {l_phd_#1_margin_top_width_dim}    {##1},  
     #1~margin-right-width/.code   = \dim_set:cn {l_phd_#1_margin_right_width_dim}  {##1}, 
     #1~margin-bottom-width/.code  = \dim_set:cn {l_phd_#1_margin_bottom_width_dim} {##1},  
     #1~margin-left-width/.code    = \dim_set:cn {l_phd_#1_margin_left_width_dim}   {##1}, 
% 
}
}
\def\makenumberingkeys #1 {     
% Numbering Wow!
\cxset{
     #1~number~prefix/.code        = \cs_gset:cpn {l_phd_#1_number_prefix_tl} {##1},
     #1~number~suffix/.code        = \cs_gset:cpn {l_phd_#1_number_suffix_tl} {##1},
     
     #1~number~after/.code         = \cs_gset:cpn {l_phd_#1_number_after_tl},
     #1~numbering/.is~choice,
     #1~numbering/roman/.code          =
       \cs_gset:cpn {the#1}
         {
           \cs:w l_phd_#1_number_prefix_tl \cs_end: 
             \@roman\cs:w c@#1\cs_end:\relax
           \cs:w l_phd_#1_number_suffix_tl \cs_end:   
         },
     #1~numbering/Roman/.code          =
      \cs_gset:cpn {the#1}
        {
          \cs:w l_phd_#1_number_prefix_tl \cs_end: 
          \expandafter\@Roman{\cs:w c@#1\cs_end:\relax} 
          \cs:w l_phd_#1_number_suffix_tl \cs_end:  
        },
    #1~numbering/(roman)/.code          =
    \cs_gset:cpn {the#1}
       {
       \cs:w l_phd_#1_number_prefix_tl \cs_end: 
         (\@roman\cs:w c@#1\cs_end:\relax)
       \cs:w l_phd_#1_number_suffix_tl \cs_end:    
       },
    #1~numbering/(Roman)/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end: 
        (\@Roman \cs:w c@#1\cs_end:\relax)
        \cs:w l_phd_#1_number_suffix_tl \cs_end:  
      },
   #1~numbering/arabic/.code           =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end: 
        \@arabic\cs:w c@#1\cs_end: \relax
        \cs:w l_phd_#1_number_suffix_tl \cs_end: 
      },
   #1~numbering/numeric/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end: 
        \@arabic\cs:w c@#1\cs_end:\relax
        \cs:w l_phd_#1_number_suffix_tl \cs_end: 
      },
   #1~numbering/none/.code             = 
    \cs_gset:cpn {the#1} {},
   #1~numbering/alpha/.code            = 
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end: 
        \exp_after:wN \alphalph {\cs:w c@#1\cs_end:\relax}
        \cs:w l_phd_#1_number_suffix_tl \cs_end:   
      },
   #1~numbering/Alpha/.code            = 
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end: 
          \exp_after:wN \AlphAlph{\cs:w c@#1\cs_end:\relax}
        \cs:w l_phd_#1_number_suffix_tl \cs_end:  
      },
   #1~numbering/words/.code            = 
    \cs_gset:cpn {the#1}
      {
       \cs:w l_phd_#1_number_prefix_tl \cs_end: 
       \words@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w l_phd_#1_number_suffix_tl \cs_end:  
      },
   #1~numbering/Words/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end: 
        \Words@cx{\@arabic\cs:w c@#1\cs_end:\relax }
        \cs:w l_phd_#1_number_suffix_tl \cs_end:  
      },
   #1~numbering/WORDS/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w l_phd_#1_number_prefix_tl \cs_end:   
       \WORDS@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w l_phd_#1_number_suffix_tl \cs_end:  
      },
   #1~numbering~custom/.code           = 
    \cs_gset:cpn {the#1} {##1},        
  }   
 }   
%  
%



\clist_map_inline:Nn \phd_book_divisions_clist
  {
    \makekeys{#1}
  }
  
\clist_map_inline:Nn \phd_book_divisions_clist
  {
    \makenumberingkeys{#1}
  } 
 
\ExplSyntaxOff
%    \end{macrocode}
% \subsection{Creating keys for the auxiliary elements}
%  This is now getting complex. We need to create the other element keys. 
%  chapter title text-align etc..
%  
%  So we should have been passing double arguments to our previously defined 
%  function. This screws up the idea completely of fully automating the key
%  lists. Need to review carefully before I go any further to avoid a lot of duplication!.
%    \begin{macrocode}
\ExplSyntaxOn
\gdef\makeotherelements #1 #2 {
  \cxset{
  %     
     #1~#2~width/.code          = 
        \expandafter\def\cs:w l_phd_#1_#2_width_dim\cs_end:{##1},
% title margins        
     #1~#2~margin-top/.code       = \dim_gset:cn {l_phd_#1_#2_margin_top_width_dim} {##1}\relax,
     #1~#2~margin-right/.code     = \dim_gset:cn {l_phd_#1_#2_margin_right_width_dim} {##1}\relax,
     #1~#2~margin-bottom/.code    = \dim_gset:cn {l_phd_#1_#2_margin_bottom_width_dim} {##1}\relax,
     #1~#2~margin-left/.code      = \dim_gset:cn {l_phd_#1_#2_margin_left_width_dim} {##1}\relax,
     #1~#2~align/.textalign           = l_phd_#1_#2_align_tl, 
% fonts
     #1~#2~font-size/.fontsize        = l_phd_#1_#2_fontsize_tl,
     #1~#2~font-weight/.fontweight    = l_phd_#1_#2_fontweight_tl, 
     #1~#2~font-shape/.fontstyle      = l_phd_#1_#2_fontshape_tl,  
     #1~#2~font-family/.fontfamily    = l_phd_#1_#2_fontfamily_tl,
% color     
     #1~#2~color/.code                = \cs_gset:cpn {l_phd_#1_#2_color_tl} {\color{##1}},       
   }
 }
\def\makeotherelementsaux #1 
{
     \makeotherelements {#1}{title}
     \makeotherelements {#1}{label}   % chapter_label is Chapter
     \makeotherelements {#1}{number}  % chapter_number refers to the number
     \makeotherelements {#1}{before}
     \makeotherelements {#1}{after}
}

\clist_map_inline:Nn \phd_book_divisions_clist 
{
  \makeotherelementsaux {#1} 
}  

     
  
\ExplSyntaxOff 
%    \end{macrocode}
%    \begin{macrocode}
\cxset
  { 
    chapter title margin-top       = 0cm, 
    chapter title margin-right     = 1cm,
    chapter align                  = Centering,
    chapter title align            = Centering, %checked
    chapter name                   = Section,
    chapter format                 = block,
    chapter font-size              = HUGE,
    chapter font-weight            = bold,
    chapter font-family            = sffamily,
    chapter font-shape             = upshape,
    chapter color                  = spot!30,
    chapter number prefix          = ,
    chapter number suffix          = ,
    chapter numbering              = arabic,
    chapter indent                 = 0pt,
    chapter beforeskip             = 10pt,
    chapter afterskip              = -3ex,
    chapter afterindent            = off,
    chapter number after           = \quad,
%    
    chapter arc                    = 3pt,
    chapter background-color       = spot!30,
    chapter afterindent            = off, 
    chapter grow left              = 0mm,
    chapter grow right             = 0mm,
    chapter rounded corners        = northeast,
    chapter shadow                 = drop shadow,
%    
    chapter border-left-width      = 0pt,
    chapter border-right-width     = 0pt,
    chapter border-top-width       = 2pt,
    chapter border-bottom-width    = 2pt,
    chapter padding-left-width     = 0pt,
    chapter padding-right-width    = 10pt,
    chapter padding-top-width      = 10pt,
    chapter padding-bottom-width   = 10pt,
    %
    chapter number font-size        = Huge,
    chapter number font-weight      = bfseries,
    chapter number font-family      = sffamily,
    chapter number font-shape       = upshape, 
    chapter number color            = spot!30,  
%
    chapter title font-size        = Huge,
    chapter title font-weight      = bold,
    chapter title font-family      = sffamily,
    chapter title font-shape       = upshape, 
    chapter title color            = spot!30,   
}  
%    \end{macrocode}
%
%    \begin{macrocode} 
\ExplSyntaxOn 

\cxset 
  { 
    section~spaceout/.is~choice,
    section~spaceout/soul/.code            = \@sectionspaceouttrue,
    section~spaceout/none/.code            = \@sectionspaceoutfalse,
 }  
 
\ExplSyntaxOff 
%    \end{macrocode}
% As described earlier boxed headings have numerous elements, each of which can be styled
% on its own. 
% 
%
%
% \chapter{Formatters}

% We first define some formatters to tie up with using |format| in sectioning commands.
%
%    \begin{macrocode}
\ExplSyntaxOn
\cs_set:Npn \format_inmargin:nnn #1#2#3
  {
     \tcbdocmarginnote
     { 
       
       \hbox{Section~\@svsec}
       #3
     } 
  }    
\ExplSyntaxOff  
%    \end{macrocode}
%
%    \begin{macrocode}
\ExplSyntaxOn
% 1 skip from left
% 2 
\cs_set:Npn \format_hang:nn #1#2#3 
  {{ \@hangfrom{#2\relax\@svsec%
      \interlinepenalty \@M #3\@@par}%
  }}
\ExplSyntaxOff
%    \end{macrocode}
%
% \subsection{Block format}
%
% Before we start setting boxes within boxes, we need a function to rename
% parameters to enable automatic creation of styles for all the boxed
% elements. The following elements in block formats are contained in
% their own boxes. Each box has its own style.
%  
%    \begin{macrocode}

\ExplSyntaxOn
\cs_gset:Npn \phd_set_box_parameters:nn #1 #2
{
  % background color  
    \cs_if_exist:cTF {l_phd_#1_background_color_tl}
      {
        \cs_set:cpn {#1tcbbgcolor} { \cs:w l_phd_#1_background_color_tl\cs_end: }
      }
      {
        \cs_set:cpn {#1tcbbgcolor} {white} 
      }
% 
   \cs_if_exist:cTF {l_phd_#1_arc_tl}
     {
       \cs_set:cpn {tcbarc_#2}
              {\cs:w l_phd_#1_arc_tl \cs_end: }
     }
     {
        \cs_set:cpn {tcbarc_#2} {0pt}
     }
% alignment \FIRE
%\cs_if_exist:cTF {l_phd_#1_align_tl}
%     {
%        \cs_gset:cpn {chaptertcbalign} {\cs:w l_#1_align_tl\cs_end:}
%     }
%     {
%        \cs_gset:cpn {chaptertcbalign} {undefined}
%     }
%  \l_phd_section_grow_left_dim         
\cs_if_exist:cTF {l_phd_#1_grow_left_dim}
    {
      \def\tcbgrowleft{\csname l_phd_#1_grow_left_dim \endcsname} 
    }
    {
      \def\tcbgrowleft{0pt}
    }
\cs_if_exist:cTF {l_phd_#1_grow_right_dim}
    {
      \def\tcbgrowright{\cs:w l_phd_#1_grow_right_dim \cs_end:} 
    }
    {
      \def\tcbgrowright{0pt}
    } 
    
\cs_if_exist:cTF {l_ phd_#1_shadow_tl}
    {
      \gdef\tcbshadow
       {
        \cs:w l_phd_#1_shadow_tl \cs_end:
       } 
    }
    {
      \gdef\tcbshadow{no~shadow}
    } 

\cs_if_exist:cTF {l_phd_#1_rounded_corners_tl}
    {
      \def\tcbroundedcorners{\cs:w l_phd_#1_rounded_corners_tl \cs_end:} 
    }
    {
      \def\tcbroundedcorners{all}
    } 
 % dimensional constants
  \dim_if_exist:cTF { l_phd_#1_title_margin_top_width_dim }
    {
      \gdef\tcbtitlevspace{\dim_use:c { l_phd_#1_title_margin_top_width_dim} } 
    }
    {
      \gdef\tcbtitlevspace{0pt}
    } 
  \dim_if_exist:cTF {l_phd_#1_border_top_width_dim }
    {
      \def\tcbtoprulewidth{\dim_use:c {l_phd_#1_border_top_width_dim} }
    }
    {
      \def\tcbtoprulewidth{0pt}
    }    
 \dim_if_exist:cTF {l_phd_#1_border_left_width_dim }
    {
      \def\tcbleftrulewidth{\dim_use:c {l_phd_#1_border_left_width_dim} }
    }
    {
      \def\tcbleftrulewidth{0pt}
    } 
 
 \dim_if_exist:cTF {l_phd_#1_border_bottom_width_dim }
    {
      \def\tcbbottomrulewidth{\dim_use:c {l_phd_#1_border_bottom_width_dim} }
    }
    {
      \def\tcbbottomrulewidth{0pt}
    }           
 \dim_if_exist:cTF {l_phd_#1_border_right_width_dim }
    {
      \def\tcbrightrulewidth {\dim_use:c {l_phd_#1_border_right_width_dim} }
    }
    {
      \def\tcbrightrulewidth{0pt}
    } 
    
    
% Padding       
\dim_if_exist:cTF {l_phd_#1_padding_top_width_dim }
    {
      \cs_set:cpn {#1tcbtopsepwidth} {\dim_use:c {l_phd_#1_padding_top_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbtopsepwidth} {0pt}
    }    
 \dim_if_exist:cTF {l_phd_#1_padding_left_width_dim }
    {
      \cs_set:cpn {#1tcbleftsepwidth} {\dim_use:c {l_phd_#1_padding_left_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbleftsepwidth} {0pt}
    } 
 
 \dim_if_exist:cTF {l_phd_#1_padding_bottom_width_dim }
    {
      \cs_set:cpn {#1tcbbottomsepwidth} {\dim_use:c {l_phd_#1_padding_bottom_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbbottomsepwidth} {0pt}
    }           
 \dim_if_exist:cTF {l_phd_#1_padding_right_width_dim }
    {
      \cs_set:cpn {#1tcbrightsepwidth} {\dim_use:c {l_phd_#1_padding_right_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbrightsepwidth} {0pt}
    }        
    
}         
%    \end{macrocode}
% 
% \begin{docCommand}{make_box_style:n}{ \meta{label name} \meta{style second name} }
%   Every block formatted heading is contained in an outer box. This has
%   a named style such as |outerbox section|. There is a lot of name swapping
%   to generally abstract any element.
% \end{docCommand}
%
%    \begin{macrocode} 
\cs_set:Npn \make_box_style:n #1 #2
  {
    \phd_set_box_parameters:nn {#1}{#2} %section outer
    \tcbset
      {
        #1~#2/.style=
          {
            size               = minimal, %resets
            enhanced,
            colback            = white, %fix\cs:w #1tcbbgcolor \cs_end:, 
            colframe           = black!80, 
            sharpish~corners,
            sharp~corners      = all,
            %arc                = 6mm,%\tcbarc_outer,
            auto~outer~arc,                   
            rounded~corners    = east,%\tcbroundedcorners,
            %\tcbshadow,   
            fuzzy~shadow       = {2mm}{-1mm}{0mm}{0.1mm}{black!50!white},
% padding           
%            left               = \csname #1tcbleftsepwidth \endcsname,
            right              = 10mm,%\cs:w #1tcbrightsepwidth  \cs_end:,
            bottom             = 3mm,%\cs:w #1tcbbottomsepwidth \cs_end:,
            top                = 3mm,%\cs:w #1tcbtopsepwidth    \cs_end:,
% frame rules           
%            toprule            = \tcbtoprulewidth,
%            leftrule           = \tcbleftrulewidth,
%            rightrule          = \tcbrightrulewidth,
%            bottomrule         = \tcbbottomrulewidth,
% border rules           
%            grow~to~right~by   = 1cm,% \tcbgrowright,
%            grow~to~left~by    = 1cm, %\tcbgrowleft,
%            boxsep             = 10pt,
%            valign~lower       = center,%not necessary?
%           interior~style     = {left~color=blue!20!white,
%                                 right~color=blue!30!white},
%\if@debug
%            borderline~north   = {0pt}{-1pt}{red},  
%            borderline~south   = {0pt}{-1pt}{red},   
%            borderline~east    = {0pt}{0pt}{red},
%            borderline~west    = {0pt}{0pt}{red},                             
%\fi%makestyle          
       }
    }   
  }   
\tcbset{
  chapter/.style = {
%            borderline~north   = {0pt}{0pt}{orange},  
%            borderline~south   = {0pt}{0pt}{orange},   
%            borderline~east    = {0pt}{0pt}{orange},
%            borderline~west    = {0pt}{0pt}{orange},   
      }
  }
\tcbset{
  _title/.style = {
%            borderline~north   = {0pt}{0pt}{yellow},  
%            borderline~south   = {0pt}{0pt}{yellow},   
%            borderline~east    = {0pt}{0pt}{yellow},
%            borderline~west    = {0pt}{0pt}{yellow},   
      }
  }    
\tcbset{
  _number/.style = {
%            borderline~north   = {0pt}{0pt}{blue},  
%            borderline~south   = {0pt}{0pt}{blue},   
%            borderline~east    = {0pt}{0pt}{blue},
%            borderline~west    = {0pt}{0pt}{blue},   
      }
  }   

 \tcbset{section/.style={chapter}} 
 \tcbset{subsection/.style={chapter}} 
 \tcbset{subsubsection/.style={chapter}}   
%    \end{macrocode}
%
% \begin{docCommand}{format_block:nnnn} {\meta{}\meta{}\marg{}\marg{}}
%   This function is the main function for block and fancy headings. It
%   is also used for Chapter and part formatting. Depending on the 
%   settings it contains the following boxes:\\
%   1.0 Label box e.g., section\\
%   2.0 Number box e.g., 1.12.24\\
%   3.0 Title\\
%   It also handles the before and after boxes that handle rules and 
%   ornamentation if any. 
%
% \end{docCommand}
% 
%    \begin{macrocode}    
\bool_new:N \combo_if_bool \bool_gset_true:N \combo_if_bool

\cs_set:Npn \format_block:nnnn #1#2#3#4
{
 \bgroup
 \make_box_style:n {#1} {outer} 
 \make_box_style:n {#1} {inner} 
 \leftskip-1cm
 \begin{tcolorbox}[
                   #1~outer, 
                   width=\linewidth+2cm,
                   arc=3mm,
                   %drop~shadow=black,
                   %rounded~corners=all,
                   colback=spot!15
                  ] 
%\phd_float_box:nnn {#1}{}
%  {
%         \tcbox{\cs:w #1name\cs_end: }
%  } 
\bool_if:NTF \combo_if_bool 
  {
    \phd_float_box:nnn {#1}{_number}
        { 
          \tcbox[size=minimal,
                 nobeforeafter,
                 colback=spot!15,
           fontlower={
             \l_phd_chapter_number_fontweight_tl
             \l_phd_chapter_number_fontfamily_tl
             \l_phd_chapter_number_fontshape_tl
             \l_phd_chapter_number_fontsize_tl
              },
          ] 
          { 
            \cs:w #1name\cs_end:\space 
            \cs:w the#1\cs_end:
           }
        } 
   }
   {         
     \phd_float_box:nnn {#1}{}
       {
         \tcbox{\@svsec}
  
       }  
   }
%  
    \dim_compare:nNnTF {\tcbtitlevspace} > {0sp}
    {
      \skip_vertical:N \tcbtitlevspace
    }
    {}
% above title box {empty}    
   \phd_float_box:nnn {#1}{}{}     
% title float box    
   \phd_float_box:nnn {#1}{_title}{#4}
   \par
   \end{tcolorbox}
 \egroup  
 \par\nobreak\nointerlineskip
}    
%    \end{macrocode}
%
%
%  \begin{docCommand} {phd_float_box} { \marg{} \marg{} \marg{}}
%    |#1|  The section label\\
%    |#2|  The secondary identifier i.e, title\\
%    |#3|  The text of the box\\
%  \end{docCommand}
%
%  This box contains an outer and an inner box, permitting the second box to float freely into
%  the first box. The widths are constrained based on user inputs or automatic calculations.
%
%    \begin{macrocode}
\cs_set:Npn \phd_float_box:nnn #1 #2 #3
{
  \begin{tcolorbox}
    [#1~outer,
      size=minimal,no~shadow,colback=spot!15, 
      #1
    ]
    \cs:w l_phd_#1#2_align_tl \cs_end:
    \begin{tcolorbox}
      [
        #1~outer,#2,
        size=minimal, no~shadow,colback=spot!15,
        %drop~shadow, 
        width=0.7\textwidth, 
       ]
          \language-1\relax
      \cs:w  l_phd_#1#2_fontweight_tl  \cs_end:
      \cs:w  l_phd_#1#2_fontfamily_tl  \cs_end:
      \cs:w  l_phd_#1#2_fontsize_tl    \cs_end:
      \cs:w  l_phd_#1#2_fontshape_tl   \cs_end:
     % \cs:w  l_phd_#1#2_color_tl       \cs_end:
      \cs:w  l_phd_#1#2_align_tl       \cs_end: 
      #3
      \par
  \end{tcolorbox}
   \par
  \end{tcolorbox}
}

\ExplSyntaxOff
%    \end{macrocode}
% 
% \subsection{Display format}
% The display format typesets a heading in a similar fashion to 
% traditional chapters.
%
% \begin{docCommand}{format_display:nn} {\marg{section name}} { \marg{skip after number} \marg {} }
%   Displays a section similar to Chapters
% \end{docCommand}
%  \#1 Section name \\
%  \#2 indent       \\
%  \#3 format para        \\
%  \#4 Title text\\
%  svsec number
%    \begin{macrocode}
\ExplSyntaxOn
\cs_set:Npn \format_display:nnnn #1 #2 #3 #4
{
  \cxset{#1~title~margin-top=30pt}
  \format_block:nnnn {#1}{#2}{#3}{#4}
}
 \ExplSyntaxOff
%    \end{macrocode}
%
% \#1 name
% \#2 indent
% \#3 title
%  
%    \begin{macrocode}
\ExplSyntaxOn
\cs_set:Npn \format_inline:nnn #1 #2 #3
  {
   {\bfseries\normalfont
    \theparagraph #3}
   }    
\ExplSyntaxOff  
%    \end{macrocode}
%
% \chapter{Layout Engine Code}
%
% The standard kernel factory commands, they are real locomotives. To hook into them
% we need to dig deep.
%
% We also define \cs{@startsection} as somehow there are problems
% with after indent false. valid |\section*{title}|, |\section[toc-entry]|, 
% |\section [toc-entry] {title}|
%
%  |#1| name i.e, section
%  |#2| level number 2 section
%  |#3| indent
%  |#4| beforeskip
%  |#5| afterskip
%  |#6|  styling command
%
%    \begin{verbatim}
% \def\@startsection#1#2#3#4#5#6{%
%    \if@noskipsec \leavevmode \fi
%    \par
%    \@tempskipa #4\relax 
%    \@afterindenttrue
%    \ifdim \@tempskipa <\z@
%        \@tempskipa -\@tempskipa\@afterindentfalse
%    \fi
%    \if@nobreak
%    \everypar{}%
%    \else
%      \addpenalty\@secpenalty\addvspace\@tempskipa
%    \fi
%   \@ifstar
%   {\@ssect{#3}{#4}{#5}{#6}}%defined in the kernel
%   {\@dblarg{\@sect{#1}{#2}{#3}{#4}{#5}{#6}}}}
%    \end{verbatim}
%   
%    \begin{macrocode}
\ExplSyntaxOn
\DeclareDocumentCommand \start_section:nnnnnnnnn {m m m m m m s o m}      
  {
    \if@noskipsec \leavevmode \fi
    \par
%    check for before skip    
    \l_tmpa_skip #4\relax 
    \@afterindenttrue
    \if_dim:w \l_tmpa_skip <\z@
% make it positive    
      \skip_gset:Nn\l_tmpa_skip {-\l_tmpa_skip}  
      \@afterindentfalse
    \fi:
%    
    \if@nobreak
      \everypar{\tikzi[start\\sect]}
    \else
      \addpenalty \@secpenalty
      \addvspace\l_tmpa_skip
    \fi
%
% redirect depending on star or option
%     
    \IfBooleanTF {#7}
      {\@ssect {#3} {#4} {#5} {#6} {#9} }
      {
        \IfValueTF {#8} {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} }
                        {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} } %sends TF we get it later
      }   
  }
\@ltxcompattrue
\if@ltxcompat 
  \else 
  \cs_gset_eq:NN \@startsection \start_section:nnnnnnnnn
\fi

\ExplSyntaxOff  
%    \end{macrocode}
%

%    \begin{macrocode}
\ExplSyntaxOn
\cs_set:Npn \@sect: #1 #2 #3 #4 #5 #6 [#7] #8 
  {

%  Decide if we need to add the section in the toc.
    \int_compare:nTF {#2>\c@secnumdepth} 
      {
         \let\@svsec\@empty
      }
      {
        \refstepcounter{#1}
        \protected@edef\@svsec
          {
            \@seccntformat{#1}\relax
          }
        % add short title or long title  
        \IfValueTF{#7}  
          { 
             \cs:w #1mark\cs_end: {#7} 
             \addcontentsline{toc}{#1}{
                \protect\numberline{\csname the#1\endcsname}#7}
          }
          { 
             \cs:w #1mark\cs_end: {#8} 
              \addcontentsline{toc}{#1}{ 
                \protect\numberline{\csname the#1\endcsname}#8}
          }
      } 
     
% 
   \@tempskipa #5\relax
   \gdef\@svsechd{
   %\@seccntformat{#1}#6{\hskip #3\relax #8}
   #8
   }%
%  \ifdim \@tempskipa>\z@
%    \end{macrocode}

%    \begin{macrocode}
    \str_case_x:nnTF {\cs:w l_phd_#1_format_tl \cs_end:}  
      {
          { display } {\format_display:nnnn { #1 } { #3 } {#6} { #8 } 
                        \xsect:n {#5}   } 
          { block   } { \format_block:nnnn  {#1 } { #3 } {#6} { {#8}       } 
                        \xsect:n {#5} 
                      } 
          { plain   } { \format_hang:nn    {#1} { #3 } { #8 }         } 
          { hangs    } { \format_hang:nn    { #1 } { #3 } {{#6#8}} \xsect:n {#5}   }
          { inline   } {  \xsect:n {-3.5ex} }%#5
          { inmargin } {\format_inmargin:nnn {#1} {#3} {#6#8} }
      }
      {
      %{\if@debug~\tiny\csname#1format@cx\endcsname \fi }
      } %true code
      { 
        { 
        %\if@debug~\tiny\csname#1format@cx\endcsname\fi
        }
        \@hangfrom{#6\relax\@svsec}%
        \interlinepenalty\@M {#6#8}\par\xsect:n{#5} 
      } %false code 
  %
  }
\ExplSyntaxOff  
%    \end{macrocode}
%
% \begin{docCommand}{@ssect} { {\meta{indent}} {\meta{beforeskip}} {\meta{afterskip}} \meta{styling commands} \meta{arg1} }
% This is the star verson of the command.  What it means is that we want a heading with
% no numbers and not in the toc. Also it does not add it as a mark! This is very limiting
% as originally programmed in the kernel; probably the thinking was to use it to create
% same style headings, that one would use for purposes other than sectioning. In reality
% many books have unnumbered sections and one might want them to go on the headings.
% We modify it to be able to do both based on a settings command.
% So to summarize star section means unumbered. Will use choices as
% to what must be done with it.
%
%  
%  \#1 indent\\
%  \#2 beforeskip\\
%  \#3 afterskip\\
%  \#4 styling command\\
%  \#5 arg1 follows\\
%
% \end{docCommand} 
%    \begin{macrocode}  
\ExplSyntaxOn  
%  
\cs_set:Npn \@ssect #1 #2 #3 #4 #5 {%
  \@tempskipa #3\relax
  \ifdim \@tempskipa>\z@
  \begingroup
    #4{
    \@hangfrom{\hskip #1}%
    \interlinepenalty \@M (#5)\@@par}%
    \endgroup
  \else
  \def\@svsechd{#4{\hskip #1\relax #5}}%
  \fi
% |\xsect:n{afterskip}| then sets the afteskipping as well as the afterindent.   
  \xsect:n{#3} %ONLY NEEDED FOR HANG PARA
}
%   
\ExplSyntaxOff   
   
%    \end{macrocode}
%
% \begin{docCommand}{@xsect:n} {\marg{afterskip}}
%  This command sets handles indentation after a sectioning command. It also handles
%  the printing of the title for inline sections (it is saved as |\@svsechd| earlier. It is common
%  for both the star and unstarred versions of |\section|.
% \end{docCommand}
%
%|\@noskipsec| A switch set true by a sectioning command when it is creating an
%in-text heading with |\everypar|.
%    \begin{macrocode}
\ExplSyntaxOn
\cs_set:Npn \xsect:n #1 
  { 
  \l_tmpa_skip #1\relax
  \if_dim:w \l_tmpa_skip>0pt %WATCH better boolean
    \par \nobreak
    \vskip\l_tmpa_skip
    \@afterheading 
   \else:
    \@nobreakfalse
    \global\@noskipsectrue
    \tex_everypar:D 
      {\if@noskipsec
          \global\@noskipsecfalse%resets switch
          {\setbox\z@\lastbox}
          \tex_clubpenalty:D\@M
          \group_begin:
            \parindent0pt\tcbox[size=minimal,
                    nobeforeafter,
                    box~align=base]{\bfseries \@svsechd }%} 
          \group_end:
          \tex_unskip:D
          \l_tmpa_skip #1\relax
          \hskip -\l_tmpa_skip
        \else
          \tex_clubpenalty:D \@clubpenalty
          \tex_everypar:D {\tikzi[every]}
        \fi
      }
  \fi:
  \tex_ignorespaces:D
  }

\cs_set:Npn \after_block:n #1 
 {
   \par \nobreak
    \vskip\l_tmpa_skip
    \@afterheading
 }    
  
  
\ExplSyntaxOff
 \def\@afterheading{%
 \@nobreaktrue
 \everypar{%
   \if@nobreak
     \@nobreakfalse
     \clubpenalty \@M
     \if@afterindent 
     \else
      {\setbox\z@\lastbox}%
     %\tikzi[everypar]
     \fi
 \else
 \clubpenalty \@clubpenalty
 \everypar{
   %\tikzi[cleared]
 }%
 \fi}
 }  
%    \end{macrocode}
%
% 
% When LaTeX is typesetting the section number it calls |\@seccntformat|
% to use it when typsetting a section heading number. This is common for
% all the subsectioning commands. We modify it based on code from \pkgname{sectsty} in order
% to generalize it.
% 
% We first check if \meta{section}|@cntformat| is defined and then we redirect
% to specific section level command.
%
% \begin{docCommand} {@seccntformat} {\marg{section name}}
%  This is a \latexe kernel factory command that produces |thesection| etc.
%  In the kernel it only takes a generic value, where we have 
%  \refCom{section_number_after_tl}.
%  We modify to enable adjustable values for all sectioning commands. 
% \end{docCommand}
%
%    \begin{macrocode}
\ExplSyntaxOn
 \cs_gset:Npn \@seccntformat #1
 {
  \@ifundefined{#1@cntformat}%
  {\csname the#1\endcsname\section_number_after_tl}% default
  {\csname #1_cntformat\endcsname}% individual control
 }
%    \end{macrocode}
%
% \begin{docCommand}{section_number_after_tl} { \meta{void}}
%  This function and its siblings are auxiliary functions.
% \end{docCommand}
%
%    \begin{macrocode}
\tl_set:Nn  \section_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsubsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \l_phd_paragraph_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subparagraph_number_after_tl{\quad}%default value only space
%
\cs_set:Npn \section_cntformat{\thesection\section_number_after_tl}
\cs_set:Npn \subsection_cntformat{\thesubsection\subsection_number_after_tl}
\cs_set:Npn \subsubsection_cntformat{\thesubsubsection\subsubsection_number_after_tl}
\cs_set:Npn \paragraph_cntformat {\theparagraph\l_phd_paragraph_number_after_tl }
\cs_set:Npn \subparagraph_cntformat {\thesubparagraph\subparagraph_number_after_tl }
\ExplSyntaxOff
%    \end{macrocode}
%
% \begin{docCommand}{chapter} { \meta{*} \oarg{arg1} \marg{arg2} }
%   The standard \latexe chapter is renewed next. We avoid all the complications of
%   the kernel with different longish sections for chapters and parts.
% \end{docCommand}  
%
%    \begin{macrocode}
\ExplSyntaxOn

 \renewcommand\chapter {%
   \newpage\null
    \start_section:nnnnnnnnn{chapter}%
      {0}  %level check this conflicts with source2e
      
      {\l_phd_chapter_indent_tl} %indent#2
      
      {\l_phd_chapter_before_skip_tl}%before skip#3
      
      {\l_phd_chapter_after_skip_tl}% after skip#4
      
      { 
%        \setfont@cx
%        {\l_phd_chapter_fontweight_tl}%
%        {\l_phd_chapter_fontfamily_tl}
%        {\l_phd_chapter_fontsize_tl}
%        {\l_phd_chapter_fontshape_tl}%
          %\expandafter\setfontparam@cx\l_phd_chapter_align_tl;%
          %\color{\l_phd_chapter_color_tl}%5
      }
 }%

%    \end{macrocode} 
%
% \begin{docCommand}{section} { \meta{*} \oarg{arg1} \marg{arg2} }
%   The standard \latexe subsection is renewed next. 
% \end{docCommand} 
%    \begin{macrocode}

%\if@ltxcompat
%\else
%  \renewcommand\section{%
%    \@startsection{section}%
%      {1}%level check this conflicts with source2e
%      
%      {\l_phd_section_indent_tl}%indent#2
%      
%      {\l_phd_section_before_skip_tl}%before skip#3
%      
%      {\l_phd_section_after_skip_tl}% after skip#4
%      
%      {% 
%        \setfont@cx
%        {\l_phd_section_fontweight_tl}%
%        {\l_phd_section_fontfamily_tl}
%        {\l_phd_section_fontsize_tl}
%        {\l_phd_section_fontshape_tl}%
%          \expandafter\setfontparam@cx\l_phd_section_align_tl;%
%        %  \expandafter\color{\l_phd_section_color_tl}%5
%      }
% }%
%}
%\fi
\ExplSyntaxOff
%    \end{macrocode}
% 
% \begin{docCommand}{subsection} { \meta{*} \oarg{arg1} \marg{arg2} }
%   The standard \latexe subsection is renewed next. 
% \end{docCommand}  
%     \begin{macrocode}
\ExplSyntaxOn
%\if@ltxcompat
%
%  \renewcommand\subsection
%    {
%      \@startsection{subsection}
%        {1}
%        {\l_phd_subsection_indent_tl}%indent
%        {\l_phd_subsection_before_skip_tl}%before skip#3
%        {\l_phd_subsection_after_skip_tl}% after skip#4
%      
%        { 
%        \setfont@cx
%          {\l_phd_subsection_fontweight_tl}
%          {\l_phd_subsection_fontfamily_tl}
%          {\l_phd_subsection_fontsize_tl}
%          {\l_phd_subsection_fontshape_tl}
%         % \expandafter\setfontparam@cx\l_phd_subsection_align_tl;%
%          %\color{\l_phd_subsection_color_tl}%5
%        }
%   }
%\fi
\ExplSyntaxOff
%\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
%                                     {-3.25ex\@plus -1ex \@minus -.2ex}%
%                                     {1.5ex \@plus .2ex}%
%                                     {\normalfont\large\bfseries\raggedright}}
%\fi
%
%    \end{macrocode}
%
%  
% \begin{docCommand}{subsubsection} { \meta{*} \oarg{arg1} \marg{arg2} }
%   The standard \latexe subsection is renewed next. 
% \end{docCommand}
%   \begin{macrocode}
\ExplSyntaxOn
%\renewcommand{\subsubsection}
%{
%  \@startsection{subsubsection}%
%    {3}%level
%    {\l_phd_subsubsection_indent_tl}%indent
%    {\l_phd_subsubsection_before_skip_tl}
%    {\l_phd_subsubsection_after_skip_tl}
%    {
%      %\setfont@cx
%%    {\l_phd_subsubsection_fontweight_tl }
%%    {\l_phd_subsubsection_fontfamily_tl}
%%    {\l_phd_subsubsection_fontsize_tl}
%%    {\l_phd_subsubsection_fontshape_tl}
%%      \expandafter\setfontparam@cx
%      %\l_phd_subsubsection_align_tl; not needed here
%     % \color{\l_phd_subsubsection_color_tl}
%    }
%}       
\ExplSyntaxOff
%    \end{macrocode}
% 

%
% \subsection{Paragraphs}
%
%  We now deal with paragraphs and subparagraphs, normally termed `runinâ€™ heads, as they produce
%  headings that are inlined with the text that follows. We add hooks, so that later the key mechanism
%  can be used to pick-up values. Although they are termed runins, there is no issue to display
%  them as block.
% 
% \begin{docCommand}{paragraph} { \meta{*} \oarg{arg1} \marg{arg2} }
%  There is a feature in the standard \latexe classes that a subparagraph is indented
%  by the value of \cs{parindent}. This also features in memoir but is absent in the
%  KOMA classes. In our defaults we follow the European norm.
% \end{docCommand}
% 
%    \begin{macrocode}
\ExplSyntaxOn
%\if@ltxcompat
%\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
%                                    {3.25ex \@plus1ex \@minus.2ex}%
%                                    {-1em}%
%                                    {\normalfont\normalsize\bfseries}}
%\else
%\if@ltxcompat
%\else
%  \renewcommand\paragraph{%
%     \@startsection{paragraph}%
%     {4}%level
%     {\l_phd_paragraph_indent_tl}%indent
%     {\l_phd_paragraph_before_skip_tl}%
%     {\l_phd_paragraph_after_skip_tl}%
%     {
%%     \setfont@cx
%%      {\l_phd_paragraph_fontweight_tl}%
%%     {\l_phd_paragraph_fontfamily_tl}
%%     {\l_phd_paragraph_fontsize_tl}
%%     {\l_phd_paragraph_fontshape_tl}%
%%     \expandafter\setfontparam@cx\l_phd_paragraph_align_tl;%
%         \expandafter\color{\l_ph_paragraph_color_tl}%
%     }%
% }
%\fi
\ExplSyntaxOff
%    \end{macrocode}
%
% \begin{docCommand}{subparagraph} { \meta{*} \oarg{arg1} \marg{arg2} }
%  There is a feature in the standard \latexe classes that a subparagraph is indented
%  by the value of \cs{parindent}. This also features in memoir but is absent in the
%  KOMA classes. In our defaults we follow the European norm.
% \end{docCommand}
%    \begin{macrocode}
\ExplSyntaxOn  
\if@ltxcompat
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{0pt}%
                                       {2ex}%
                                       {-1em}%
                                      {\normalfont\normalsize\bfseries}}
\renewcommand\subparagraph
      {
         \@startsection{subparagraph}
         {5}%level
         {\l_phd_subparagraph_indent_tl}%indent
         {\l_phd_subparagraph_before_skip_tl}
         {\l_phd_subparagraph_after_skip_tl}
         {
           \setfont@cx
           {\l_phd_subparagraph_fontweight_tl}
           {\l_phd_subparagraph_fontfamily_tl}
           {\l_phd_subparagraph_fontsize_tl}
           {\l_phd_subparagraph_fontshape_tl}%
           \expandafter\setfontparam@cx
             \l_phd_subparagraph_align_tl;
           \color{\l_phd_subparagraph_color_tl}
         }
       } 

\fi
\ExplSyntaxOff
%    \end{macrocode}
%

% 
% \cxset{section numbering=arabic}
% 
%
% \chapter{Default Settings}
%
% Setting default values
%
%
%    \begin{macrocode}
\cxset { section name              = Section,
    section format                 = block,
    section align                  = Centering,
    section title align            = Centering, %checked
%    
    section font-size              = Large,
    section font-weight            = bfseries,
    section font-family            = serif,
    section font-shape             = upshape,
%    
    section number font-size       = Large,
    section number font-weight     = bfseries,
    section number font-family     = serif,
    section number font-shape      = upshape,    
%
    section title font-size        = Large,
    section title font-weight      = bfseries,
    section title font-family      = serif,
    section title font-shape       = upshape,
%    
    section color                  = spot,
    section number prefix          = \thechapter.,
    section number suffix          =,
    section numbering              = arabic,
    section indent                 = 0pt,
    section beforeskip             = -3ex,
    section afterskip              = 10pt,
    section afterindent            = off,
    section number after           = \quad,
%    
    section arc                    = 3pt,
    section background-color       = white,
    section afterindent            = off, 
    section grow left              = 0mm,
    section grow right             = 0mm,
    section rounded corners        = northeast,
%    
    section border-left-width      = 0pt,
    section border-right-width     = 0pt,
    section border-top-width       = 2pt,
    section border-bottom-width    = 2pt,
%
    section padding-left-width     = 0pt,
    section padding-right-width    = 10pt,
    section padding-top-width      = 2pt,
    section padding-bottom-width   = 2pt,
%
    section title margin-top       = 2pt, 
    section title color            = spot,    
    section shadow                 = no shadow,  
  }   
%    \end{macrocode} 
%    \begin{macrocode}
\cxset
  { 
    subsection name                   = Subsection,
    subsection format                 = block, 
%    
    subsection font-size              = large,  
    subsection font-weight            = bfseries,
    subsection font-family            = rmfamily,
    subsection font-shape             = upshape,
%
    subsection number font-size       = large,  
    subsection number font-weight     = bfseries,
    subsection number font-family     = rmfamily,
    subsection number font-shape      = upshape,
%    
    subsection title font-size        = Large,
    subsection title font-weight      = bfseries,
    subsection title font-family      = serif,
    subsection title font-shape       = upshape,
    subsection title color            = spot,    
%        
    subsection color                  = spot,
    subsection numbering              = arabic,
    subsection align                  = Centering, %checked
    subsection title align            = Centering, %checked
    subsection beforeskip             = -3.25ex\@plus -1ex \@minus -.2ex,
    subsection afterskip              = 1.5ex \@plus .2ex,
    subsection number prefix          = \thesection.,
    subsection indent                 = 0pt,
    subsection number after           = 0pt,
    subsection background-color       = white,
%    
    subsection border-left-width      = 0pt,
    subsection border-right-width     = 0pt,
    subsection border-top-width       = 5pt,
    subsection border-bottom-width    = 5pt,
%
    subsection padding-left-width     = 0pt,
    subsection padding-right-width    = 0pt,
    subsection padding-top-width      = 20pt,
    subsection padding-bottom-width   = 20pt,                
    subsection shadow                 = drop shadow,
  }
%    \end{macrocode}
%    \begin{macrocode}
\cxset
  { 
    subsubsection name                    = Subsubsection,
    subsubsection format                  = block,  
    subsubsection background-color        = white!30, %checked
%    
    subsubsection font-family             = rmfamily, 
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
%    
    subsubsection font-family             = rmfamily, 
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
%    
    subsubsection color                   = spot,
    subsubsection number prefix           = \thesubsection,
    subsubsection number suffix           = ,
    subsubsection numbering               = arabic,
    subsubsection indent                  = 0pt,
    subsubsection beforeskip              = -3.25ex\@plus -1ex \@minus -.2ex,
    subsubsection afterskip               = 1.5ex \@plus .2ex,
    subsubsection align                   = center,
    subsubsection title align             = center,
    subsubsection number after     =,
%    
    subsubsection border-left-width       = 0pt,
    subsubsection border-right-width      = 0pt,
    subsubsection border-top-width        = 2pt,
    subsubsection border-bottom-width     = 0pt,
%
    subsubsection padding-left-width      = 0pt,
    subsubsection padding-right-width     = 0pt,
    subsubsection padding-top-width       = 20pt,
    subsubsection padding-bottom-width    = 20pt, 
    subsubsection shadow                  = no shadow,  
%
    subsubsection title font-size         = large,
    subsubsection title font-weight       = bfseries,
    subsubsection title font-family       = serif,
    subsubsection title font-shape        = upshape,
    subsubsection title color             = spot,          
  }
%    \end{macrocode}
%
%    \begin{macrocode}
% paragraph
\cxset
  {
    paragraph name                = paragraph,
    paragraph format              = inline, 
    paragraph name                = paragraph,
    paragraph font-size           = large,
    paragraph font-weight         = bfseries,
    paragraph font-family         = rmfamily,
    paragraph font-shape          = upshape,
    paragraph numbering           = alpha,
    paragraph align               = flushleft,
    paragraph beforeskip          = 3.25ex plus1ex minus.2ex,
    paragraph afterskip           = -1em,
    paragraph indent              = 0pt,
    paragraph number after        = \quad,
    paragraph color               = spot,
    paragraph background-color    = white,
    paragraph shadow              = no shadow,
  }
%    \end{macrocode}
%    \begin{macrocode}    
\cxset
  {
    subparagraph name             = subparagraph,
    subparagraph format           = inline,
    subparagraph name             = subparagraph, 
    subparagraph font-size        = large,
    subparagraph font-weight      = bfseries,
    subparagraph font-family      = rmfamily,
    subparagraph font-shape       = upshape,
    subparagraph color            = spot!30,
    subparagraph background-color = sweet!50
    subparagraph numbering        = none,
    subparagraph align            = flushleft,
    subparagraph beforeskip       = 3.25ex plus1ex minus .2ex,
    subparagraph afterskip        = -1em,
    subparagraph indent           = 0pt,
    subparagraph number after     = ,
    subparagraph shadow           = off, 
  }
%    \end{macrocode}
%
% \section{Styles}
%    \begin{macrocode}  
\cxset{chapter title style/.style= {
       chapter title align = Centering,}
 } 
\cxset{section title style/.style= {
       section title align = Centering,}
 } 
\cxset{section title style/.style= {
       section title align = Centering,}
 }
 \cxset{subsection title style/.style= {
       subsection title align = Centering,}
 }
 \cxset{subsubsection title style/.style= 
   {
        subsubsection align       = #1,
        subsubsection title align = #1,
   }
 }
 \cxset{subsubsection title style= raggedright}
%    \end{macrocode}
% \cxset{chapter afterskip=60pt}
% \chapter[test]{Tests}
%
%  We prepare a number of tests to verify that all settings work as advertized.
%
% \begin{docCommand}{testsections} {\meta{void}}
%  In honor of Barbara Beeton all testing commands are in lowercase, but we also provide
%  them in mixed case for the rest of the crowd.
% \end{docCommand}
%    \begin{macrocode}
\ExplSyntaxOn
\cs_set:Npn \testsections 
  {
    \section{Sections}
    \lorem\par
    \subsection{Subsections}
    \lorem\par
    \subsubsection{Subsubsections}
    \lorem\par
    \paragraph {Paragraph}
  }
\cs_set_eq:NN \TestSections\testsections  
\ExplSyntaxOff  
%    \end{macrocode}
% \testsections
%  \cxset{section format = hang,
%         section font-size=large,
%         section font-weight=bold,
%         subsection format=hang,
%         subsection font-family=sffamily,
%         chapter title font-size=Huge,
%         chapter number font-size=Huge,
%         chapter number font-family =sffamily ,
%         chapter align  = centering,
%}
% 
% \chapter{Another Test} 
% \section{\lorem}
% \subsection{\lorem}

%</LSECT>
\endinput
