%%
%% This is file `phd-lowersections.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% phd-lowersections.dtx  (with options: `LSECT')
%% phd-specials.dtx  (with options: `SPECIAL')
%% ----------------------------------------------------------------
%% phd-lowersectons --- A package to beautify documents.
%% E-mail: yannislaz@gmail.com
%% Released under the LaTeX Project Public License v1.3c or later
%% See http://www.latex-project.org/lppl.txt
%% ----------------------------------------------------------------
\NeedsTeXFormat{LaTeX2e}[2017/04/15]%
\ProvidesFile{phd-lowersections}[2017/04/15 v1.0 Better headings (YL)]%
\ExplSyntaxOn
\let\ltxtoday\today
\let\phd_hang_from:nn \@hangfrom
\newif\if@ltxcompat \@ltxcompatfalse
\ExplSyntaxOff


\newif\if@DEBUG
\@DEBUGfalse

\def\DEBUGON{
\@DEBUGtrue
\if@DEBUG
\def\tikzi[##1]{%
    \begin{tikzpicture}[remember picture,overlay]
                \draw[<->] (0,0)--(0,.2)--++(-.5,0) node[left,fill=blue!15,text=black]%
                {
                   \parbox{2cm}
                    {
                       {\sffamily
                        \footnotesize ##1 }
                    }
                };
   \end{tikzpicture}%
}
\else
\def\tikzi[##1]{}
\fi}

\def\DEBUGOFF{
\@DEBUGfalse
\if@DEBUG
\def\tikzi[##1]{%
    \begin{tikzpicture}[remember picture,overlay]
                \draw[<->] (0,0)--(0,.2)--++(-.5,0) node[left,fill=blue!5,text=black]%
                {
                   \parbox{2cm}
                    {
                       {\sffamily
                        \footnotesize ##1 }
                    }
                };
   \end{tikzpicture}%
}
\else
\def\tikzi[##1]{}
\fi
}

\DEBUGON

\ExplSyntaxOn
\def\lphdsubsectionnumberprefixtl {}
\def\lphdsubsectionnumbersuffixtl {}
\def\lphdsubsubsectionnumberprefixtl{}
\def\lphdsubsubsectionnumbersuffixtl{}
\def\lphdparagraphnumberprefixtl{}
\def\lphdparagraphnumbersuffixtl{}
\def\lphdsubparagraphnumberprefixtl{}
\def\lphdsubparagraphnumbersuffixtl{}
\clist_new:N \__phd_document_types_clist {}
\tl_new:N \__phd_document_type_tl {}
\cs_new_nopar:Npn \__phd_set_document_type:n #1
  {
    \tl_gset:Nn \__phd_document_type_tl {#1}
    %create secondary list as well here
    \clist_gput_right:Nn \__phd_document_types_clist {#1}
    \clist_new:c {__phd_#1_divisions_clist}
  }
\__phd_set_document_type:n {book}
\cs_new:Npn \__phd_set_document_divisions #1 #2 {
  \clist_gset:cn {__phd_#1_divisions_clist} {#2}
}

\__phd_set_document_divisions {book}
  {
    part,chapter,section,subsection,subsubsection,
    paragraph,subparagraph
  }

\__phd_set_document_divisions {article}
  {
    section,subsection,subsubsection,
    paragraph,subparagraph
  }

\__phd_set_document_divisions {proc}
  {
    section,subsection,subsubsection,
    paragraph,subparagraph
  }

\__phd_set_document_divisions {journal}
  {
    volume,article,section,subsection,subsubsection,
    paragraph,subparagraph
  }
\__phd_set_document_divisions {bible}
  {
    testament,book,chapter,verse
  }
\cs_new:Npn \element_delimiter{.}
\clist_new:N \thirdlist
\cs_new:Npn \z_make_names #1 {
   % append to third list
   \clist_map_inline:Nn \__phd_book_divisions_clist {
     \clist_put_right:Nn \thirdlist{##1\element_delimiter#1}
   }
 }

\clist_new:N   \__phd_secondary_clist_names_clist
\clist_gset:Nn \__phd_secondary_clist_names_clist
 {
   label,label_before,number,title, title_before,number_before
 }
\clist_map_inline:Nn \__phd_secondary_clist_names_clist
  {
     \z_make_names {#1}
  }
 \clist_new:N \__phd_secondary_clist
 \clist_gset:Nn \__phd_secondary_clist
 {
   part_label,
   part_label_before,
   part_number,
   part_title,
   part_title_before
   part_number_before,

   chapter_title,
   section_title,
   subsection_title,
   subsubsection_title,
   paragraph_title,
   subparagraph_title,
   chapter_title_before,
   chapter_label,
   section_label,
   subsection_label,
   subsubsection_label,
   paragraph_label,
   subparagraph_label,
   chapter_label_before,
   chapter_number,section_number,
   subsection_number,subsubsection_number,
   paragraph_number,subparagraph_number,

   chapter_number_before,

 }
\cs_new:Npn \__phd_create_new_element:nn #1
  {
    \dim_gzero_new:c {l__phd_#1_margin_top_width_dim} %margin
    \dim_gzero_new:c {l__phd_#1_margin_right_width_dim}
    \dim_gzero_new:c {l__phd_#1_margin_bottom_width_dim}
    \dim_gzero_new:c {l__phd_#1_margin_left_width_dim}

    \dim_gzero_new:c {l__phd_#1_padding_top_width_dim} %margin
    \dim_gzero_new:c {l__phd_#1_padding_right_width_dim}
    \dim_gzero_new:c {l__phd_#1_padding_bottom_width_dim}
    \dim_gzero_new:c {l__phd_#1_padding_left_width_dim}

    \dim_gzero_new:c {l__phd_#1_border_top_width_dim} %margin
    \dim_gzero_new:c {l__phd_#1_border_right_width_dim}
    \dim_gzero_new:c {l__phd_#1_border_bottom_width_dim}
    \dim_gzero_new:c {l__phd_#1_border_left_width_dim}
 }
\clist_map_inline:Nn \__phd_book_divisions_clist
  {
    \__phd_create_new_element:nn {#1}
  }

\clist_map_inline:Nn \__phd_secondary_clist
  {
    \__phd_create_new_element:nn {#1}
  }

\cs_new:Npn \printproperties
  {
    \input{debug-dims}
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \l__phd_make_new_heading_keys:n #1 #2
 {
  \cxset
    {
     #1~name/.store                = #1name,
     locale/en/#1~name/.store      = #1name,
     #1~afterindent/.onoff         = #1_afterindent,
     #1~align/.textalign           = l__phd_#2_align_tl,
     #1~beforeskip/.store          = l__phd_#2_beforeskip_tl,
     #1~afterskip/.store           = l__phd_#2_afterskip_tl,
     #1~indent/.store              = l__phd_#2_indent_tl,
     #1~font-size/.fontsize        = l__phd_#2_fontsize_tl,
     #1~font-weight/.fontweight    = l__phd_#2_fontweight_tl,
     #1~font-shape/.fontstyle      = l__phd_#2_fontshape_tl,
     #1~font-style/.fontstyle      = l__phd_#2_fontshape_tl,
     #1~font-family/.fontfamily    = l__phd_#2_fontfamily_tl,
     #1~font-face/.fontface        = l__phd_#2_fontface_tl,
     #1~case/.case                 = l__phd_#2_case_tl,
     #1~format/.format~in          = l__phd_#2_format_tl,
     #1~background-color/.store        = l__phd_#2_background_color_tl,
     #1~frame-color/.store             = l__phd_#2_frame_color_tl,
     #1~color/.colorin                 = l__phd_#2_color_tl,
     #1~shadow/.shadow                 = l__phd_#2_shadow_tl,
     #1~width/.store                   = l__phd_#2_width,
     #1~arc/.store                     = l__phd_#2_arc_tl,
     #1~grow~left/.store               = l__phd_#2_grow_left_dim,
     #1~grow~right/.store              = l__phd_#2_grow_right_dim,
     #1~rounded~corners/.store         = l__phd_#2_rounded_corners_tl,
     #1~borderline~top/.store          = l__phd_#2_borderline_top_tl,
     #1~borderline~right/.store        = l__phd_#2_borderline_right_tl,
     #1~borderline~bottom/.store       = l__phd_#2_borderline_bottom_tl,
     #1~borderline~left/.store         = l__phd_#2_borderline_left_tl,
     #1~borderline~top-color/.store    = l__phd_#2_borderline_top_color_tl,
     #1~borderline~right-color/.store  = l__phd_#2_borderline_right_color_tl,
     #1~borderline~bottom-color/.store = l__phd_#2_borderline_bottom_color_tl,
     #1~borderline~left-color/.store   = l__phd_#2_borderline_left_color_tl,
     #1~border-top-width/.store        = l__phd_#2_border_top_width_dim,
     #1~border-right-width/.store      = l__phd_#2_border_right_width_dim,
     #1~border-bottom-width/.store     = l__phd_#2_border_bottom_width_dim,
     #1~border-left-width/.store       = l__phd_#2_border_left_width_dim,
     #1~padding-top-width/.store       = l__phd_#2_padding_top_width_dim,
     #1~padding-right-width/.store     = l__phd_#2_padding_right_width_dim,
     #1~padding-bottom-width/.store    = l__phd_#2_padding_bottom_width_dim,
     #1~padding-left-width/.store      = l__phd_#2_padding_left_width_dim,
     #1~margin-top-width/.store        = l__phd_#2_margin_top_width_dim,
     #1~margin-right-width/.store      = l__phd_#2_margin_right_width_dim,
     #1~margin-bottom-width/.store     = l__phd_#2_margin_bottom_width_dim,
     #1~margin-left-width/.store       = l__phd_#2_margin_left_width_dim,
   }
 }

\ExplSyntaxOff

\ExplSyntaxOn
\cs_gset:Npn \make_new_bool:n #1
  {
    \bool_new:c {#1_open_left_bool}
    \bool_gset_false:c {#1_open_left_bool}
    \bool_new:c {#1_open_any_bool}
    \bool_gset_false:c {#1_open_any_bool}
    \bool_new:c {#1part_open_anywhere_bool}
    \bool_gset_false:c {#1_open_anywhere_bool}
    \bool_new:c {#1_open_right_bool}
    \bool_gset_false:c {#1_open_right_bool}
  }

\make_new_bool:n {part}
\make_new_bool:n {chapter}
\make_new_bool:n {section}
\ExplSyntaxOff
\ExplSyntaxOn
\cs_gset:Npn \make_new_opening_keys:n #1
{
 \cxset{
    #1~opening/.is~choice,
    #1~opening/right/.code      = \bool_gset_true:c {#1_open_right_bool},
    #1~opening/left/.code       = \bool_gset_true:c {#1_open_left_bool},
    #1~opening/any/.code        = \bool_gset_true:c {#1_open_any_bool},
    #1~opening/none/.code       = \bool_gset_true:c {#1_open_anywhere_bool},
    #1~opening/anywhere/.code   = \bool_gset_true:c {#1_open_anywhere_bool},
    #1~opening/ifafter/.code={},
 }
}
\make_new_opening_keys:n {part}
\make_new_opening_keys:n {chapter}
\make_new_opening_keys:n {section}
\ExplSyntaxOff
\cxset{part opening = anywhere,
          chapter opening = anywhere,
          section opening = none}
\ExplSyntaxOn
\cs_new:Npn \l__phd_make_new_numbering_keys:n #1
  {
\cxset{
     #1~number~prefix/.store       = lphd#1numberprefixtl,
     #1~number~suffix/.store       = lphd#1numbersuffixtl,

     #1~number~after/.store        = l__phd_#1_number_after_tl,
     #1~numbering/.is~choice,
     #1~numbering/roman/.code          =
       \cs_gset:cpn {the#1}
         {
           \cs:w lphd#1numberprefixtl \cs_end:
             \@roman\cs:w c@#1\cs_end:\relax
           \cs:w lphd#1numbersuffixtl \cs_end:
         },
     #1~numbering/Roman/.code          =
      \cs_gset:cpn {the#1}
        {
          \cs:w lphd#1numberprefixtl \cs_end:
          \expandafter\@Roman{\cs:w c@#1\cs_end:\relax}
          \cs:w lphd#1numbersuffixtl \cs_end:
        },
    #1~numbering/(roman)/.code          =
    \cs_gset:cpn {the#1}
       {
       \cs:w lphd#1numberprefixtl \cs_end:
         (\@roman\cs:w c@#1\cs_end:\relax)
       \cs:w lphd#1numbersuffixtl \cs_end:
       },
    #1~numbering/(Roman)/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w lphd#1numberprefixtl \cs_end:
        (\@Roman \cs:w c@#1\cs_end:\relax)
        \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering/arabic/.code           =
    \cs_gset:cpn {the#1}
      {
        \cs:w lphd#1numberprefixtl \cs_end:
        \@arabic\cs:w c@#1\cs_end: \relax
        \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering/numeric/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w lphd#1numberprefixtl \cs_end:
        \@arabic\cs:w c@#1\cs_end:\relax
        \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering/none/.code             =
    \cs_gset:cpn {the#1} {},

   #1~numbering/alpha/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w lphd#1numberprefixtl \cs_end:
        \exp_after:wN \alphalph {\cs:w c@#1\cs_end:\relax}
        \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering/Alpha/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w lphd#1numberprefixtl \cs_end:
          \exp_after:wN \AlphAlph{\cs:w c@#1\cs_end:\relax}
        \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering/words/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w lphd#1numberprefixtl \cs_end:
       \words@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering/Words/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w lphd#1numberprefixtl \cs_end:
        \Words@cx{\@arabic\cs:w c@#1\cs_end:\relax }
        \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering/WORDS/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w lphd#1numberprefixtl \cs_end:
       \WORDS@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w lphd#1numbersuffixtl \cs_end:
      },
    #1~numbering/ordinals/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w lphd#1numberprefixtl \cs_end:
       \ordinals@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w lphd#1numbersuffixtl \cs_end:
      },
    #1~numbering/ORDINALS/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w lphd#1numberprefixtl \cs_end:
       \ORDINALS@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w lphd#1numbersuffixtl \cs_end:
      },
   #1~numbering~custom/.code           =
    \cs_gset:cpn {the#1} {##1},
  }
 }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_gset:Npn\phd_setparent:nn #1#2 {%
   \cs_gset:cpn {#1parent} {#2}
}
\phd_setparent:nn {document}{root}
\phd_setparent:nn {part}{document}
\phd_setparent:nn {chapter}{document}
\phd_setparent:nn {section}{chapter}
\phd_setparent:nn {subsection}{section}
\phd_setparent:nn {subsubsection}{subsection}
\phd_setparent:nn {paragraph}{subsubsection}
\clist_map_inline:Nn \__phd_book_divisions_clist
  {
    \l__phd_make_new_heading_keys:n{#1}{#1}
    \l__phd_make_new_numbering_keys:n{#1}
  }
\clist_map_inline:Nn \__phd_book_divisions_clist
  {
    \iow_log:n {#1, }
    \l__phd_make_new_heading_keys:n {#1~title}{#1_title}
    \l__phd_make_new_heading_keys:n {#1~title~before}{#1_title_before}
    \l__phd_make_new_heading_keys:n {#1~number}{#1_number}
    \l__phd_make_new_heading_keys:n {#1~number~before}{#1_number_before}
    \l__phd_make_new_heading_keys:n {#1~label}{#1_label}
    \l__phd_make_new_heading_keys:n {#1~label~before}{#1_label_before}
    \l__phd_make_new_heading_keys:n {#1~before}{#1_before}
    \l__phd_make_new_heading_keys:n {#1~after}{#1_after}
  }

\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \l__phd_set_headings_key_defaults:n #1
  {
    \cxset
      {
       % #1~name                   = Chapter,
      %  #1~numbering              = arabic,
        #1~align                  = Centering,
        #1~format                 = block,
        #1~font-size              = HUGE,
        #1~font-weight            = bold,
        #1~font-family            = sffamily,
        #1~font-shape             = upshape,
        #1~font-style             = upshape,
        #1~case                   = upper,
        #1~color                  = black,
        #1~background-color       = bgsexy,
        #1~frame-color            = bgsexy,
        #1~indent                 = 0pt,
        #1~beforeskip             = 10pt,
        #1~afterskip              = -3ex,
        #1~afterindent/.onoff     = #1_afterindent,
        #1~arc                    = 0pt,

        #1~grow~left              = 0mm,
        #1~grow~right             = 0mm,
        #1~rounded~corners        = northeast,
        #1~shadow                 = drop~shadow,
        #1~borderline~top          = 1pt,
        #1~borderline~right        = 1pt,
        #1~borderline~bottom       = 1pt,
        #1~borderline~left         = 1pt,
        #1~borderline~top-color    = black,
        #1~borderline~right-color  = black,
        #1~borderline~bottom-color = black,
        #1~borderline~left-color   = black,
        #1~border-left-width      = 1pt,
        #1~border-right-width     = 1pt,
        #1~border-top-width       = 1pt,
        #1~border-bottom-width    = 1pt,

        #1~padding-left-width     = 1pt,
        #1~padding-right-width    = 1pt,
        #1~padding-top-width      = 1pt,
        #1~padding-bottom-width   = 1pt,
     }
  }
\clist_map_inline:Nn \__phd_book_divisions_clist
  { \wlog{set defaults ... #1 ...,}
    \l__phd_set_headings_key_defaults:n {#1}
    \l__phd_set_headings_key_defaults:n {#1~title}
    \l__phd_set_headings_key_defaults:n {#1~title~before}
    \l__phd_set_headings_key_defaults:n {#1~label}
    \l__phd_set_headings_key_defaults:n {#1~label~before}
    \l__phd_set_headings_key_defaults:n {#1~number}
    \l__phd_set_headings_key_defaults:n {#1~number~before}
    \l__phd_set_headings_key_defaults:n {#1~before}
    \l__phd_set_headings_key_defaults:n {#1~after}
  }
\ExplSyntaxOff


\ExplSyntaxOn
\cxset
  {
    section~spaceout/.is~choice,
    section~spaceout/soul/.code            = \@sectionspaceouttrue,
    section~spaceout/none/.code            = \@sectionspaceoutfalse,
 }
\ExplSyntaxOff

\ExplSyntaxOn
\cs_gset:Npn \set_font_aux:n #1
 {
   %\cs_if_exist_use:c { #1_fontface_tl}
   \cs_if_exist_use:c { #1_fontfamily_tl }
   \cs_if_exist_use:c { #1_fontweight_tl }
   \cs_if_exist_use:c { #1_fontshape_tl  }
   \cs_if_exist_use:c { #1_fontsize_tl   }

 }
\cs_new:Npn \set_borders_aux:nn #1 #2
 {
   \dim_if_exist:cTF{l__phd_#1_border_#2_width_dim } {8pt}{2pt}
  }

\cs_new:Npn \set_color_aux:nn #1 #2
 {
   \cs:w l__phd_#1_#2_color_tl \cs_end:
 }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \set_borderline_aux:nn #1 #2
{
   \tcbset{borderline~style/.style =
   {
     borderline~west = {\cs:w l__phd_#1_borderline_left_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {left}-0pt }
                       {
                        \cs:w l__phd_#1_borderline_left_color_tl \cs_end: ,
                         solid,
                       },
     borderline~east = {\cs:w l__phd_#1_borderline_right_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {right}-0pt }
                       {
                         \cs:w l__phd_#1_borderline_right_color_tl \cs_end:,
                         solid
                       },
     borderline~north = {\cs:w l__phd_#1_borderline_top_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {top}-0pt }
                       { \cs:w l__phd_#1_borderline_top_color_tl \cs_end:,
                        dashed},
     borderline~south = {\cs:w l__phd_#1_borderline_bottom_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {bottom}-0pt }
                       {
                         \cs:w l__phd_#1_borderline_bottom_color_tl \cs_end:,
                         dashed
                       },
    }
  }
}
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_inmargin:nnn #1#2#3
  {
     \tcbdocmarginnote
     {

       \hbox{Section~\@svsec}
       #3
     }
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_hang:nn #1#2#3
  {\par\leavevmode
    \phd_hang_from:nn
        {
         \set_font_aux:n {l__phd_#1}
         \cs_if_exist_use:c {the_#1_title_fontface_tl}
         \cs:w
          l__phd_#1_number_color_tl
          \cs_end:
         {\hskip 0pt %indent
           \cs:w the#1 \cs_end:
           \hskip1em
         }
        }
        {
          \set_font_aux:n {l__phd_#1}
          \cs_if_exist_use:c {the_section_title_fontface_tl}
          \cs:w
          l__phd_#1_color_tl
          \cs_end:
          #3

        }
   { \interlinepenalty\@M
    \par } %Check par here
    \par \nobreak
    %\skip_vertical:c {l__phd_#1_afterskip_tl}
    \vskip10pt
    \phd_after_heading:
    \tex_ignorespaces:D
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_hang_inmargin:nn #1#2
  {
    \bgroup
    \parindent0pt
    \setbox\@tempboxb\hbox
     {
       \set_font_aux:n {l__phd_#1}
       \expandafter\@arabic\cs:w c@#1 \cs_end:
     }
     \makebox[0pt]{
          \makebox[-\wd\@tempboxb][r]{%
         \set_font_aux:n {l__phd_#1}
         {
           \tcbox[nobeforeafter,box~align=center,
                  colback=bgsexy]
                  {
                    \cs:w the#1 \cs_end:
                  }
         }
        }
        }
     \begin{tcolorbox}[enhanced,
                      %title empty,
                       size=minimal,
                       nobeforeafter,box~align=center,
                       title,title code={
\path[draw=yellow,solid,decorate,line width=2mm,
decoration={coil,aspect=0,segment length=10.1mm}]
([xshift=1mm]title.west) -- ([xshift=-1mm]title.east);}
                       ]
          \set_font_aux:n {l__phd_#1}
          \cs:w
          l__phd_#1_color_tl
          \cs_end:
          #2
    \end{tcolorbox}
    \egroup
    \interlinepenalty\@M
    \tex_par:D
    \par \nobreak
    \skip_vertical:c {l__phd_#1_afterskip_tl}
    \phd_after_heading:
  }
\ExplSyntaxOff
\ExplSyntaxOn
\bool_new:N \combo_if_bool \bool_gset_true:N \combo_if_bool
\cs_set:Npn \label_number_box #1 {
 \bool_if:NTF \combo_if_bool
     {
         \fboxsep=2pt
         \fboxrule=1pt
         %\phd_float_box:nnn {chapter_number} {}{
                \tcbox[size=minimal,
                nobeforeafter,
                before = \vskip1sp,
                colback=white]
                {
                   %\cs:w l__phd_#1_fontsize_tl\cs_end:
                   \tcbox[size=minimal,
                          nobeforeafter,
                          colback= \cs:w l__phd_chapter_label_background_color_tl \cs_end:,
                          valign=top,
                          ]{
                     \bgroup
                     \cs_if_exist_use:c { the_#1_fontface_tl}
                     \cs_if_exist_use:c {l__phd_#1_label_fontfamily_tl}
                     \cs_if_exist_use:c {l__phd_ #1_label_fontweight_tl}
                     \cs_if_exist_use:c {l__phd_#1_label_fontshape_tl}
                     \cs_if_exist_use:c {l__phd_#1_label_fontsize_tl}

                     %\l__phd_chapter_label_fontfamily_tl
                     %\l__phd_chapter_label_fontshape_tl\space
                     \cs:w l__phd_#1_label_color_tl\cs_end:

                     \cs:w #1name\cs_end:\space

                   \egroup}

                   \tcbox[size=minimal,
                          nobeforeafter, top=0pt,valign=top,
                          colback=\cs:w
                               l__phd_chapter_number_background_color_tl
                          \cs_end:,
                          ]{
                     \bgroup

                     \cs_if_exist_use:c { the_#1_number_fontface_tl    }
                     \cs_if_exist_use:c {l__phd_#1_number_fontfamily_tl }
                     \cs_if_exist_use:c {l__phd_#1_number_fontweight_tl }
                     \cs_if_exist_use:c {l__phd_#1_number_fontshape_tl  }
                     \cs_if_exist_use:c {l__phd_#1_number_fontsize_tl   }
                     \cs:w l__phd_#1_number_color_tl\cs_end:
                     \vphantom{\chaptername}
                     \cs:w the#1\cs_end:\scan_stop:
                     \egroup
                    }
              }
           %}
    }
    {
     \phd_float_box:nnn {#1}{}
       {
         \tcbox{\@svsec}

       }
    }
}

\cs_set:Npn \format_block:nnnn #1#2#3#4
  {
    \bgroup
    %\leftskip-1.25in
    \set_borderline_aux:nn {#1}{}
    \noindent\begin{tcolorbox}[size=minimal,
      width       = \textwidth-4pt, %\pdfpagewidth-4cm,
      %arc         = 10mm,
      %auto~outer~arc,
      \cs_if_exist_use:cTF {l__phd_#1_shadow_tl}{}{},
        colback           = white,  %bgsexy!5,%\set_color_aux:nn {#1}{background},FIXME THIS IS WROBG
        colframe          = white, %\set_color_aux:nn {#1}{frame},
        toprule           = \set_borders_aux:nn {#1} {top},
        rightrule         = \set_borders_aux:nn {#1} {right},
        bottomrule        = \set_borders_aux:nn {#1} {bottom},
        leftrule          = 0pt,%\set_borders_aux:nn {#1} {left},
        left~skip =0pt,
        left=0pt,
        boxsep=0pt,
      %  borderline        = {5pt}{5pt}{blue,double,dashed,line~join=bevel},
     %  borderline~north = {2pt}{-3pt}{dotted},
     %  borderline~south = {2pt}{-3pt}{dotted},
     %  borderline~east  = {2pt}{-3pt}{dotted},
     %  borderline~west  = {2pt}{-3pt}{dotted},
      % borderline~style,
       % no~borderline,
       % show~bounding~box,
        halign = left,
        valign = top,
        %rounded~corners=all,
        %drop~lifted~shadow=black,
     ]

    \label_number_box {#1}
   \phd_float_box:nnn {#1_title_before}{}{}

  \phd_float_box:nnn {#1_title}{}{#4}
   \par
   \vskip10pt %TODO
   \end{tcolorbox}
   \vskip10pt
 \egroup
 \par\nobreak\nointerlineskip
}
\cs_set:Npn \phd_float_box:nnn #1 #2 #3
{\set_borderline_aux:nn {#1}{}

  \begin{tcolorbox}
    [
      size=minimal,
      width = \linewidth,
      no~shadow,
      colback  = \cs:w l__phd_#1_background_color_tl \cs_end:,
      colframe = \cs:w l__phd_#1_frame_color_tl \cs_end:,
      toprule  = 0pt,
      borderline~style,
      boxsep=0pt,
      left~skip=0pt,
      left=0pt,
      right=0pt,
      right~skip=0pt,
     ]

    \set_font_aux:n {l__phd_#1}
    \cs:w l__phd_#1_align_tl \cs_end:
    %in between box or title or author block
    \begin{tcolorbox}
      [
        %#1~outer,
        size=minimal,
        no~shadow,
        colback = white,%\cs:w l__phd_#1_background_color_tl \cs_end:,
        colframe= white,%\cs:w l__phd_#1_frame_color_tl \cs_end:,,
        boxsep=0pt,
        top=0pt,
        bottom=0pt,
        left=0pt,
        right=2pt,
        %drop~shadow,
        %width=\linewidth,
        borderline~style,
       % halign = ,
       ]
       {   \language-1\relax
       %\RaggedRight
      \set_font_aux:n {l__phd_#1_tl}
      \cs:w  l__phd_#1_color_tl  \cs_end:
      \cs:w  l__phd_#1_align_tl  \cs_end:
       {\textsl{\textls{#3}}}\relax %
       \vskip10pt
       }
  \end{tcolorbox}
    \par
  \end{tcolorbox}
}

\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_display:nnnn #1 #2 #3 #4
{
  %\cxset{#1~title~margin-top-width=30pt}
  \format_block:nnnn {#1}{#2}{#3}{#4}
}
 \ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_inline:nnn #1 #2 #3
  {
   {\bfseries\normalfont
    \theparagraph #3}
   }
\ExplSyntaxOff

\ExplSyntaxOn
\cs_new:Npn \format_part_traditional:nn #1 #2 #3
  {\par\leavevmode
   \group_begin:
      \centering
     \interlinepenalty \@M
     \set_font_aux:n {l__phd_#1}
     \cs:w l__phd_#1_number_tl\cs_end:
     \set_font_aux:n {l__phd_#1_number}
     \ifnum \c@secnumdepth >-2\relax
       \csname #1name\endcsname\nobreakspace\csname the#1\endcsname
       \par
       \vskip 20\p@
     \fi
     \group_begin:
       %\set_color:nn {#1}{color}
       \set_font_aux:n {l__phd_#1 }
          #3
     \group_end:
     \tex_par:D
     \vskip20pt
   \group_end:

  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \format_traditional:nn #1 #2 #3
  {\par\leavevmode
   \group_begin:
    \centering
     \interlinepenalty \@M
     \set_font_aux:n {l__phd_#1}
     \cs:w l__phd_#1_number_tl\cs_end:

     \ifnum \c@secnumdepth >-2\relax
       \set_font_aux:n {l__phd_#1_number}

       \csname #1name\endcsname\nobreakspace\csname the#1\endcsname
       {
         \cxset{chapter~label~font-family=\ovidius}
         \begin{tikzpicture}
         \node (a) at (0,0) {\expandafter\csname#1name\endcsname};
         \node (b) at (0,15pt) {\tiny \set_font_aux:n{l__phd_chapter_label} test};
        \end{tikzpicture}
       }
       \par
       \vskip 20\p@
     \fi
     \group_begin:
       %\set_color:nn {#1}{color}
       \set_font_aux:n {l__phd_#1 }
          #3
     \group_end:
     \par
     \vskip20pt
   \group_end:

  }
\ExplSyntaxOff
\ExplSyntaxOn
\DeclareDocumentCommand \start_section:nnnnnnnnn {m m m m m m s o m}
  {
    \if@noskipsec \leavevmode \fi
    \par
    \l_tmpa_skip #4\relax
    \@afterindenttrue
    \if_dim:w \l_tmpa_skip <\z@
      \skip_gset:Nn\l_tmpa_skip {-\l_tmpa_skip}
      \@afterindentfalse

    \fi:

    \bool_if:cTF {#1_afterindent}{
       \@afterindentfalse
    }{\@afterindenttrue}
    \if@nobreak
      \everypar{\tikzi[start\\sect] \bool_if:cTF {#1_afterindent}{\tikzi[TRUE]}{\tikzi[falsy]}  }
    \else
      \addpenalty \@secpenalty
      \addvspace\l_tmpa_skip
    \fi
    \IfBooleanTF {#7}
    % send to star section
      {
      % This is only for LaTeX Compatibility
      % name is not send which is problematic as we cannot
      % pick-up the properties
      %
         \gdef\currentsectionname{#1}
         \@ssect {#3} {#4} {#5} {#6} {#9}

      }
      {
        \IfValueTF {#8} {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} }
                        {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} }
      }
  }
\@ltxcompatfalse
\if@ltxcompat
  \else
  \cs_gset_eq:NN \@startsection \start_section:nnnnnnnnn
\fi

\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \@sect: #1 #2 #3 #4 #5 #6 [#7] #8
  {
    \int_compare:nTF {#2>\c@secnumdepth}
      {
         \let\@svsec\@empty
      }
      {
        \refstepcounter{#1}
        \protected@edef\@svsec
          {
            \@seccntformat{#1}\relax
          }
        % add short title or long title
        \IfValueTF{#7}
          {
             \cs:w #1mark\cs_end: {#7}
             \addcontentsline{toc}{#1}{
                \protect\numberline{\csname the#1\endcsname}{#7}}
          }
          {
             \cs:w #1mark\cs_end: {#8}
              \addcontentsline{toc}{#1}{
                \protect\numberline{\csname the#1\endcsname}{#8}}
          }
      }
   \@tempskipa #5\relax
   \gdef\g__phd_saved_heading_tl{#8}

   \phd_format_router:nn {#1}{#8}
}
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \phd_format_router:nn #1 #2
  {
    \str_case_x:nnTF {\cs:w l__phd_#1_format_tl \cs_end:}
      {
          { display      } {\format_display:nnnn { #1 } {  } {} { #2     }
                             \xsect:n {3.5ex}{}   }
          { block        } { \format_block:nnnn  {#1 } {  } {} { {#2}    }
                             \xsect:n {3.5ex}{#2}
                           }
          { plain        } {
                             \format_hang:nn    {#1} {  }   {#2}
                             \xsect:n {3.5ex}{#2}
                           }
          { hang         } { \format_hang:nn    { #1 } {  } {#2}         }
          { hanginmargin } {\format_hang_inmargin:nn {#1} {#2}           }
          { leftmargin   } {\format_hang_inmargin:nn {#1} {#2}           }
          { inline       } {  \xsect:n {-1ex}{#2}                        }
          { inmargin     } {\format_inmargin:nnn {#1} {} {#2}            }
          { traditional  } {\format_part_traditional:nn {#1}{}{#2}
                                      \xsect:n {5pt}{section}            }
          { paperback }  {\format_traditional:nn {#1}{}{#2}
                          \xsect:n {5pt}{section}                        }
      }
      {       }

      {
        \cs_if_exist:cTF { l__phd_#1_format_tl }
          {
            \expandafter\cs:w
               \cs:w l__phd_#1_format_tl
               \cs_end:
               \cs_end:
               %\stewart
               { #1 } { #2 }
          }
          { FALSE }
      }
  }

\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \@ssect #1 #2 #3 #4 #5 {
  \@tempskipa #3\relax
  \ifdim \@tempskipa>\z@
  \begingroup
    #4
    {
      \phd_hang_from:nn{\hskip #1}%
      \interlinepenalty \@M

      % do color

      \cs:w l__phd_\currentsectionname _title_color_tl\cs_end:
      %\pgfkeysvalueof{/phd/section~title~color}
      \set_font_aux:n{l__phd_\currentsectionname _title}
     % \pgfkeysvalueof{/phd/section~title~font-family}
      %\MakeUppercase{#5}
      #5
      \@@par
   }%
  \endgroup
  \else

  \def\@svsechd{#4{\hskip #1\relax #5}}%
  \fi
  \cxset{section~afterindent = true,
             subsection~afterindent = true,
             subsubsection~afterindent = true}
  \xsect:n{#3}{#1} %ONLY NEEDED FOR HANG PARA
}

\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \xsect:n #1 #2
  {
  \l_tmpa_skip #1\relax
  \if_dim:w \l_tmpa_skip>-1pt %WATCH better boolean
    \par \nobreak
    \vskip\l_tmpa_skip
    \phd_after_heading:

   % negative dimension
   \else:
    \@nobreakfalse
    \global\@noskipsectrue
    \tex_everypar:D
      {\if@noskipsec
          \global\@noskipsecfalse%resets switch
          {\setbox\z@\lastbox}
          \tex_clubpenalty:D\@M
          \group_begin:
            \parindent0pt
                   \tcbox[size=minimal,
                    nobeforeafter,
                    colback=white,
                    box~align=base]{\bfseries \g__phd_saved_heading_tl }%}
          \group_end:
          \tex_unskip:D
          \l_tmpa_skip #1\relax
          \hskip -\l_tmpa_skip
        \else
          \tex_clubpenalty:D \@clubpenalty
          \tex_everypar:D {\tikzi[every\bool_if:cTF {#2_afterindent}{#2~TRUE}{#2~FALSE//}]}
        \fi
      }
  \fi:
  \tex_ignorespaces:D
  }

\cs_set:Npn \after_block:n #1
 {
   \par \nobreak
    \vskip\l_tmpa_skip
    \phd_after_heading:
 }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_gset:Npn \phd_after_heading:
  {
    \@nobreaktrue
    \tex_everypar:D
      {
        \if@nobreak
          \@nobreakfalse
          \clubpenalty \@M %1000 no orphans from this point onwards
          \if@afterindent
          \else
            {\setbox\z@\lastbox}%
            \tikzi[afterheading\\
                   clubpenalty\\
                 = \the\clubpenalty]
         \fi
       \else
       \clubpenalty \@clubpenalty %150
       \tex_everypar:D
         {
           \tikzi[everypar in after heading cleared\\
                  clubpenalty\\ \the\clubpenalty
                 ]
         }
       \fi
    }
  }
\ExplSyntaxOff
\ExplSyntaxOn
 \cs_gset:Npn \@seccntformat #1
 {
  \@ifundefined{#1@cntformat}%
  {\csname the#1\endcsname\section_number_after_tl}% default
  {\csname #1_cntformat\endcsname}% individual control
 }
\tl_set:Nn  \section_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsubsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \l__phd_paragraph_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subparagraph_number_after_tl{\quad}%default value only space
\cs_set:Npn \section_cntformat{\thesection\section_number_after_tl}
\cs_set:Npn \subsection_cntformat{\thesubsection\subsection_number_after_tl}
\cs_set:Npn \subsubsection_cntformat{\thesubsubsection\subsubsection_number_after_tl}
\cs_set:Npn \paragraph_cntformat {\theparagraph\l__phd_paragraph_number_after_tl }
\cs_set:Npn \subparagraph_cntformat {\thesubparagraph\subparagraph_number_after_tl }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_gset:Npn \emptypagecontents{This~is~an~empty~page.}
\ExplSyntaxOff

\NewDocumentCommand\EmptyPageContents{ m }{
\global\long\def\emptypagecontents {#1}
}

\EmptyPageContents{%
  \vspace*{\fill}%
  \begin{center}
  \LARGE \lorem
  \end{center}
  \vspace{\fill}%
  \thispagestyle{empty}
}

\long\def\cleardoublepage{\clearpage\if@twoside\ifodd\c@page\else
  \hbox{}
    \emptypagecontents\tikzi[In Clear Double Page, empty page]
  \newpage
  \if@twocolumn\hbox{}\newpage\fi\fi\fi}
\ExplSyntaxOn
 \renewcommand\part {%
   \newpage\null
   \thispagestyle{empty}
    \start_section:nnnnnnnnn{part}%
      {-1}  %level check this conflicts with source2e
      {\l__phd_part_indent_tl} %indent#2

      {\l__phd_part_beforeskip_tl}%before skip#3

      {\l__phd_part_afterskip_tl}% after skip#4

      {
          %\expandafter\setfontparam@cx\l__phd_chapter_align_tl;%
          \l__phd_part_color_tl %5
      }
 }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_gset:Npn \phd_set_opening #1 {
    \bool_if:cT {chapter_open_left_bool}  {
       \cleartoevenpage\null
       \global\@topnum\z@~
       \tikzi[open~left]
       \bool_gset_false:c {#1_open_right_bool}
       \bool_gset_false:c {#1_open_any_bool}
       \bool_gset_false:c {#1_open_anywhere_bool}
       }
    \bool_if:cT {#1_open_right_bool}
      {
        \cleardoublepage\null
        \global\@topnum\z@~
        \tikzi[open~right]
        \bool_gset_false:c {#1_open_left_bool}
        \bool_gset_false:c {#1_open_any_bool}
        \bool_gset_false:c {#1_open_anywhere_bool}
      }
    \bool_if:cT {#1_open_any_bool}
      {
        \clearpage\null
        \global\@topnum\z@~
        \tikzi[open~any]
        \bool_gset_false:c {#1_open_left_bool}
        \bool_gset_false:c {#1_open_right_bool}
        \bool_gset_false:c {#1_open_anywhere_bool}
      }
    \bool_if:cT {#1_open_anywhere_bool}
      {
        \global\@topnum\z@~
        \tikzi[open~anywhere ]
        \bool_gset_false:c {#1_open_left_bool}
        \bool_gset_false:c {#1_open_right_bool}
        \bool_gset_false:c {#1_open_any_bool}
      }
}
\ExplSyntaxOff
\ExplSyntaxOn
 \renewcommand\chapter {%
    \phd_set_opening{chapter}
    \thispagestyle{empty}
   %\newpage
    %\bool_show:c {chapter_open_right_bool}
    \start_section:nnnnnnnnn{chapter}%
      {0}  %level check this conflicts with source2e

      {\l__phd_chapter_indent_tl} %indent#2

      {\l__phd_chapter_beforeskip_tl}%before skip#3

      {\l__phd_chapter_afterskip_tl}% after skip#4

          %\expandafter\setfontparam@cx\l__phd_chapter_align_tl;%
          %\color{\l__phd_chapter_color_tl}%5
{} 

 }%


\if@ltxcompat
\else
  \renewcommand\section{%
    \@startsection{section}%
      {1}%level check this conflicts with source2e

      {\l__phd_section_indent_tl}%indent#2

      {\l__phd_section_beforeskip_tl}%before skip#3

      {\l__phd_section_afterskip_tl}% after skip#4

      {
        \set_font_aux:n {l__phd_section}
          \l__phd_section_color_tl %5
      }
 }%
\fi
\ExplSyntaxOff
\ExplSyntaxOn
\if@ltxcompat
\else
 \renewcommand\subsection
    {
      \@startsection{subsection}
        {1}
        {\l__phd_subsection_indent_tl}%indent
        {\l__phd_subsection_beforeskip_tl}%before skip#3
        {\l__phd_subsection_afterskip_tl}% after skip#4

        {
        \set_font_aux:n {l__phd_subsection}
         % \expandafter\setfontparam@cx\l__phd_subsection_align_tl;%
         \l__phd_subsection_color_tl  %5
        }
   }
\fi
\ExplSyntaxOff
\ExplSyntaxOn
\if@ltxcompat
\else
\renewcommand{\subsubsection}
{
  \@startsection{subsubsection}%
    {3}%level
    {\l__phd_subsubsection_indent_tl}%indent
    {\l__phd_subsubsection_beforeskip_tl}
    {\l__phd_subsubsection_afterskip_tl}
    {
      \set_font_aux:n {l__phd_subsubsection}
%%    {\l_@@_subsubsection_fontweight_tl }
%%    {\l_@@_subsubsection_fontfamily_tl}
%%    {\l_@@_subsubsection_fontsize_tl}
%%    {\l_@@_subsubsection_fontshape_tl}
%%      \expandafter\setfontparam@cx
      \l__phd_subsubsection_color_tl
    }
}
\fi
\ExplSyntaxOff

\ExplSyntaxOn
  \renewcommand\paragraph{
     \@startsection{paragraph}
     {4}%level
     {\l__phd_paragraph_indent_tl}%indent
     {\l__phd_paragraph_beforeskip_tl}%
     {\l__phd_paragraph_afterskip_tl}%
     {
      \set_font_aux:n {l__phd_paragraph}
      \l__phd_paragraph_color_tl
     }%
   }
\ExplSyntaxOff
\ExplSyntaxOn
\if@ltxcompat
   \renewcommand\subparagraph{\@startsection{subparagraph}{5}{0pt}%
                                       {2ex}%
                                       {-1em}%
                                      {\normalfont\normalsize\bfseries}}
\else
\renewcommand\subparagraph
      {
         \@startsection{subparagraph}
         {5}%level
         {\l__phd_subparagraph_indent_tl}%indent
         {\l__phd_subparagraph_beforeskip_tl}
         {\l__phd_subparagraph_afterskip_tl}
         {
           \set_font_aux:n {l__phd_subparagraph}
           \expandafter\setfontparam@cx
            \l__phd_subparagraph_align_tl;
            \l__phd_subparagraph_color_tl
         }
       }

\fi
\ExplSyntaxOff

\cxset{%
    part format                       = traditional,
    chapter title margin-top-width    =  0cm,
    chapter title margin-right-width  =  1cm,
    chapter title margin-bottom-width = 10pt,
    chapter title margin-left-width   = 0pt,
    chapter align                     = left,
    chapter title align               = left, %checked
    chapter name                      = chapter,
    chapter format                    = fashion,
    chapter font-size                 = Huge,
    chapter font-weight               = bold,
    chapter font-family               = sffamily,
    chapter font-shape                = upshape,
    chapter color                     = black,
    chapter number prefix             = ,
    chapter number suffix             = ,
    chapter numbering                 = arabic,
    chapter indent                    = 0pt,
    chapter beforeskip                = -3cm,
    chapter afterskip                 = 30pt,
    chapter afterindent               = off,
    chapter number after              = ,
    chapter arc                       = 0mm,
    chapter background-color          = white,
    chapter afterindent               = off,
    chapter grow left                 = 0mm,
    chapter grow right                = 0mm,
    chapter rounded corners           = northeast,
    chapter shadow                    = fuzzy halo,
    chapter border-left-width         = 0pt,
    chapter border-right-width        = 0pt,
    chapter border-top-width          = 0pt,
    chapter border-bottom-width       = 0pt,
    chapter padding-left-width        = 0pt,
    chapter padding-right-width       = 10pt,
    chapter padding-top-width         = 10pt,
    chapter padding-bottom-width      = 10pt,
    chapter number color              = white,
    chapter label color               = black,
    chapter number font-size        = huge,
    chapter number font-weight      = bfseries,
    chapter number font-family      = sffamily,
    chapter number font-shape       = upshape,
    chapter number align            = Centering,
    chapter title font-size        = Huge,
    chapter title font-weight      = bold,
    chapter title font-family      = sffamily,
    chapter title font-shape       = upshape,
    chapter title color            = black,
}
\cxset {
    section name                   = Section,
    section format                 = traditional,
    section align                  = Centering,
    section title align            = Centering, %checked
    section font-size              = Large,
    section font-weight            = bfseries,
    section font-family            = serif,
    section font-shape             = upshape,
    section number font-size       = Large,
    section number font-weight     = bfseries,
    section number font-family     = serif,
    section number font-shape      = upshape,
    section title font-size        = Large,
    section title font-weight      = bfseries,
    section title font-family      = serif,
    section title font-shape       = upshape,
    section color                  = black,
    section number prefix          = \thechapter.,
    section number suffix          =,
    section numbering              = arabic,
    section indent                 = 0pt,
    section beforeskip             = 3ex,
    section afterskip              = 1.5ex plus .1ex,
    section afterindent            = on,
    section number after           = \quad,
    section arc                            = 3pt,
    section background-color       = white,
    section afterindent                = on,
    section grow left                   = 0mm,
    section grow right                 = 0mm,
    section rounded corners        = northeast,
    section border-left-width      = 0pt,
    section border-right-width     = 0pt,
    section border-top-width       = 2pt,
    section border-bottom-width    = 2pt,
    section padding-left-width     = 0pt,
    section padding-right-width    = 10pt,
    section padding-top-width      = 2pt,
    section padding-bottom-width   = 2pt,
    section title margin-top-width = 2pt,
    section title color            = thesectiontitlecolor,
    section shadow                 = no shadow,
}
\cxset
  {
%% sybsection
    subsection name                   = Subsection,
    subsection format                 = hang,
    subsection font-size              = large,
    subsection font-weight            = bfseries,
    subsection font-family            = rmfamily,
    subsection font-shape             = upshape,
    subsection number font-size       = large,
    subsection number font-weight     = bfseries,
    subsection number font-family     = rmfamily,
    subsection number font-shape      = upshape,
    subsection title font-size        = Large,
    subsection title font-weight      = bfseries,
    subsection title font-family      = sffamily,
    subsection title font-shape       = upshape,
    subsection title color            = bgsexy,
    subsection color                  = bgsexy,
    subsection numbering              = arabic,
    subsection align                  = Centering, %checked
    subsection title align            = Centering, %checked
    subsection beforeskip             = -3.25explus -1ex minus -.2ex,
    subsection afterskip              = 1.5ex plus .2ex,
    subsection number prefix          = \thesection.,
    subsection indent                 = 0pt,
    subsection number after           = 0pt,
    subsection background-color       = white,
    subsection border-left-width      = 0pt,
    subsection border-right-width     = 0pt,
    subsection border-top-width       = 5pt,
    subsection border-bottom-width    = 5pt,
    subsection padding-left-width     = 0pt,
    subsection padding-right-width    = 0pt,
    subsection padding-top-width      = 20pt,
    subsection padding-bottom-width   = 20pt,
    subsection shadow                 = drop shadow,
  }
\cxset
  {
    subsubsection name                    = Subsubsection,
    subsubsection format                  = hang,
    subsubsection background-color        = white, %checked
    subsubsection afterindent             = off,
    subsubsection font-family             = rmfamily,
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
    subsubsection font-family             = sffamily,
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
    subsubsection color                   = black,
    subsubsection number prefix           = \thesubsection,
    subsubsection number suffix           = ,
    subsubsection numbering               = arabic,
    subsubsection indent                  = 0pt,
    subsubsection beforeskip              = -3.25explus -1ex minus -.2ex,
    subsubsection afterskip               = 1.5ex plus .2ex,
    subsubsection align                   = center,
    subsubsection title align             = center,
    subsubsection number after     =,
    subsubsection border-left-width       = 0pt,
    subsubsection border-right-width      = 0pt,
    subsubsection border-top-width        = 2pt,
    subsubsection border-bottom-width     = 0pt,
    subsubsection padding-left-width      = 0pt,
    subsubsection padding-right-width     = 0pt,
    subsubsection padding-top-width       = 20pt,
    subsubsection padding-bottom-width    = 20pt,
    subsubsection shadow                  = no shadow,
    subsubsection title font-size         = large,
    subsubsection title font-weight       = bfseries,
    subsubsection title font-family       = serif,
    subsubsection title font-shape        = itshape,
    subsubsection title color             = thesubsectiontitlecolor,
  }
\cxset
  {
    paragraph name                = paragraph,
    paragraph format              = inline,
    paragraph name                = paragraph,
    paragraph font-size           = large,
    paragraph font-weight         = bfseries,
    paragraph font-family         = rmfamily,
    paragraph font-shape          = upshape,
    paragraph numbering           = alpha,
    paragraph number prefix       = \thesubsubsection,
    paragraph align               = flushleft,
    paragraph beforeskip          = 3.25ex plus1ex minus.2ex,
    paragraph afterskip           = -1em,
    paragraph indent              = 0pt,
    paragraph number after        = \quad,
    paragraph color               = bgsexy,
    paragraph background-color    = white,
    paragraph shadow              = no shadow,
    paragraph afterindent         = off
  }
\cxset
  {
    subparagraph name             = subparagraph,
    subparagraph format           = inline,
    subparagraph name             = subparagraph,
    subparagraph font-size        = large,
    subparagraph font-weight      = bfseries,
    subparagraph font-family      = rmfamily,
    subparagraph font-shape       = upshape,
    subparagraph color            = bgsexy,
    subparagraph background-color = bgsexy,
    subparagraph numbering        = none,
    subparagraph align            = flushleft,
    subparagraph beforeskip       = 3.25ex plus1ex minus .2ex,
    subparagraph afterskip        = -1em,
    subparagraph indent           = 0pt,
    subparagraph number after     = ,
    %subparagraph shadow           = off,
  }
\cxset{chapter title style/.style= {
       chapter title align = left,}
 }
\cxset{section title style/.style= {
       section title align = Centering,}
 }
\cxset{section title style/.style= {
       section title align = Centering,}
 }
 \cxset{subsection title style/.style= {
       subsection title align = Centering,}
 }
 \cxset{subsubsection title style/.style=
   {
        subsubsection align       = #1,
        subsubsection title align = #1,
   }
 }
 %
 \cxset{%
    subsubsection title style= raggedright
}
\newcommand{\preface}[1][\prefacename]{\chapter*{#1}\markboth{#1}{#1}}
\newcommand{\foreword}[1][\forewordname]{\chapter*{#1}\markboth{#1}{#1}}

\newcommand{\extrachap}[1]{\chapter*{#1}\markboth{#1}{#1}}
\ExplSyntaxOn
\cs_set:Npn \testsections
  {
    \section{Sections}
    \lorem\par
    \subsection{Subsections}
    \lorem\par
    \subsubsection{Subsubsections}
    \lorem\par
    \paragraph {Paragraph}
  }
\cs_set_eq:NN \TestSections\testsections
\ExplSyntaxOff
\ExplSyntaxOn
\cxset{
    offsety/.store~in        = \soffsety,
    image/.store~in          = \image@cx,
    texti/.store~in          = \texti@cx,
    textii/.store~in         = \textii@cx,
}

\cxset{offsety = 0pt,
       image   = hine02,
       texti   = \lorem,
       textii  = \lorem }
\cxset
  {
    steward/.style = {
    offsety/.store~in        = \soffsety,
    image/.store~in          = \image@cx,
    texti/.store~in          = \texti@cx,
    textii/.store~in         = \textii@cx,
    %chapter~beforeskip       = 1sp,
    %chapter~afterskip        = 1sp,
  }
}

\ExplSyntaxOff


\ExplSyntaxOn
\newcommand\stewart[2]
  {
    \clearpage
    \thispagestyle{empty}
    \begin{tikzpicture}[remember~picture,overlay]
      \node [xshift=5cm,yshift=-\paperheight] at (current~page.north~west)
            [
              text~width=\textwidth-1cm,
              text~height=\paperheight,
              fill=thecream!30,
              rounded~corners,
              above~right
            ]
            {};

      \node [xshift=6.5cm,yshift=-1.5cm-\soffsety] at (current~page.north~west)
            [text~width=0.7\textwidth,below~right]
            {
             \language-1
             \sffamily \bfseries \huge #2
            };

     \node [xshift=3cm,yshift=-1.5cm] at (current~page.north~west)
           [
             text~width=3cm,
             align=center,
             minimum~height=2.5cm,
             fill= thechaptercolor,
             below~right]
           {

             \text{\HHUGE\bfseries\sffamily\color{white}
             \cs:w the#1 \cs_end:}

             \par\vspace*{3pt}
           };

     \node [xshift=-0.2cm,yshift=-21.5cm] at (current~page.north~west)
           [text~width=3cm,above~right]%
           {\includegraphics[width=1.0\paperwidth,
             height=\textheight,keepaspectratio]{\image@cx}};

     \node [xshift=3cm,yshift=-19.5cm] at (current~page.north~west)
           [text~width=9cm,minimum~height=2.5cm,
           inner~sep=0.5em,
           fill= thechaptercolor,
           below~right]
           {\color{white}
            \bfseries\sffamily\texti@cx
           };

     \node [xshift=5.5cm,yshift=-26cm] at (current~page.north~west)
           [text~width=10cm,above~right]
           {
             \textii@cx
           };
\end{tikzpicture}
\ExplSyntaxOff
\par
\clearpage
}
\ExplSyntaxOn
\newcommand\hdr[2]
  {
    \clearpage
    \thispagestyle{empty}
    \begin{tikzpicture}[remember~picture,overlay]
    \node [xshift=-12cm,yshift=3pt] at (current~page.north~west)
           [below~right,
            minimum~height=\paperheight]
           {\includegraphics[
             height=\paperheight]{cockfight}};
    \end{tikzpicture}

    \clearpage
    \thispagestyle{empty}
    \begin{tikzpicture}[remember~picture,overlay]

      \node [xshift=0cm,yshift=0] at (current~page.north~east)
           [
             text~width=3.5cm,
             align=center,
             minimum~height=2.5cm,
             fill=bgsexy,
             below~left]
           {

             \text{\HHUGE\bfseries\sffamily\color{white}
             \cs:w the#1 \cs_end: }
             \par\vspace*{3pt}
           };

\node [xshift=-2.7cm,yshift=-10pt] at (current~page.north~east)
           [
             below~right,rotate=-90]
           {

             {\footnotesize\bfseries\sffamily\color{white}
             \expandafter\MakeTextUppercase{\cs:w #1name \cs_end:}
             }
             \par\vspace*{3pt}
           };

\node [xshift=-1.2cm, yshift=-3cm] at (current~page.north~east)
           [
             below~right,rotate=-90]
           {

             {\Huge\bfseries\sffamily\cs_if_exist_use:c {the_chapter_title_fontface_tl}
              \color{bgsexy}
             \MakeTextUppercase{#2}
             }
             \par\vspace*{3pt}
           };

\node [xshift=-\paperwidth-9cm,yshift=3pt] at (current~page.north~west)
           [below~left]%
           {\includegraphics[
             height=\paperheight]{cockfight}};

\end{tikzpicture}
\ExplSyntaxOff
\par
\clearpage
}

\def\soffsety{2pt}
\def\image@cx{hine01}
\def\texti@cx{\lorem}
\def\textii@cx{\lorem}

\newcommand\stewartpart[1] {%

 \clearpage

\begin{tikzpicture}[remember picture,overlay]
\node [xshift=5cm,
       yshift=-\paperheight] at (current page.north west)
      [text width=0.99\textwidth,
      text height=\paperheight,
      fill=thecream!30,
      above right]
{};
\node [xshift=8.5cm,yshift=-1.5cm-\soffsety] at (current page.north west)
[text width=0.9\textwidth,below right]{\sffamily \bfseries \HUGE \thechapter};
\node [xshift=4cm,yshift=-1.5cm] at (current page.north west)
[text width=4cm,align=center,minimum height=2.5cm, fill=blue,below right]
{\color{white}\bfseries\sffamily \MakeTextUppercase{#1}
\\ \text{\HHUGE\@Roman\c@part\relax}
};
\node [xshift=-0.2cm,yshift=-21.5cm] at (current page.north west)
[text width=3cm,above right]%
{\includegraphics[width=1.0\paperwidth,height=\textheight,keepaspectratio]{\image@cx}};
\node [xshift=3cm,yshift=-19.5cm] at (current page.north west)
[text width=9cm,minimum height=2.5cm,inner sep=0.5em, fill=blue,below right]
{\color{white}
  \bfseries\sffamily\texti@cx
};
\node [xshift=6.5cm,yshift=-26cm] at (current page.north west)
[text width=12cm,above right]
{\textii@cx
};
\end{tikzpicture}
\par
\clearpage
}
\ExplSyntaxOn
\cxset{band~height/.store~in=\bandheight@cx}
\cxset{band~height=5cm}

\newcommand{\tikzspecial}[1]{%

\clearpage
\ExplSyntaxOn
\let\titlefontfamily@cx\l_phd_title_font_family_tl
\let\titlefontweight@cx\l_phd_title_font_weight_tl
\ExplSyntaxOff

\begin{tikzpicture}[remember~picture,overlay]
    \node[yshift=-\bandheight@cx]~ at~ (current~page.north~west)
      {\begin{tikzpicture}[remember~picture, overlay]
        \draw[fill=bgsexy, draw=none] (0,0) rectangle (\paperwidth,\bandheight@cx);
        \node[anchor=east,
              xshift=.9\paperwidth,
              rectangle,
              rounded~corners=10pt,inner~sep=11pt,
              text~width = 0.7\linewidth,
              fill=black!80]{%
          \LARGE
          \bfseries
          \sffamily
             \lineskip2pt
             \color{white}
             \thechapter\
             \textsc{#1}};
       \end{tikzpicture}
      };
\end{tikzpicture}
\mbox{}
\vspace*{\bandheight@cx}\par
\phd_after_heading:
}
\ExplSyntaxOff
\cxset{image/.store in=\image@cx,
       image caption/.store in=\caption@cx,
       textiii/.store in=\textiii@cx}
\cxset{image      = genetics-dogs,
       image caption = Genetics,
       textiii       = \lorem}
\ExplSyntaxOn
\newcommand\genetics[1]{%
  %    \end{macrocode}
\begin{minipage}[b][\textheight][t]{\textwidth}%
\hbox{}%
      \vbox to 0pt {%
      \color{teal}%
      \hbox{\rule{\textwidth}{0.4pt}}%
      \hbox{\rule{0.4pt}{\textheight}\rule{4cm}{0.4pt}}%
    }%
\vspace*{10pt}%
\begin{minipage}[b]{\linewidth}%
\fboxsep0pt%
\fboxrule0pt%
\fbox{\begin{minipage}[b]{0.25\linewidth}%
\lineskip0pt\topskip0pt%
\leftskip0.5cm%
\leavevmode%
\bfseries\color{teal}\Large\sffamily%
\caption@cx%
\vspace*{2cm}%
\par
\includegraphics[width=\dimexpr\linewidth-0.5cm\relax,totalheight=3.8cm]{./images/chapterconcept-01.jpg}\llap{\raise20pt\hbox to \linewidth{\HHUGE \hskip1cm\color{lightgray!40}\thechapter}\hfill}%
\end{minipage}%
}%
\fbox{\begin{minipage}[b]{0.75\linewidth}%
\lineskip0pt%
\leavevmode
\includegraphics[width=1\linewidth]{\image@cx}%

\includegraphics[width=\linewidth]{./images/chapterconcept-02.jpg}.%
\end{minipage}}%
\end{minipage}%
\par
\vspace{1.5cm  plus25pt minus25pt}
\parbox[t]{0.3\linewidth}{%
  \set_font_aux:n {l_phd_chapter}
  \leftskip0.5em
  \color{teal}#1%
}%
\begin{minipage}[t]{0.6\linewidth}%
\vspace{-2\baselineskip}
\textiii@cx
\end{minipage}

\end{minipage}
\markboth{#1}{#1}
}
\ExplSyntaxOff
\ExplSyntaxOn
\cxset{
  fashion~image/.code            = \cs_set:Npn \l__fashion_image {#1},
  subtitle~font-color/.store~in  = \__fashion_subtitlefontcolor,
  fashion~image~width/.code      = \cs_set_nopar:Npx \__fashion_image_width {#1},
}
\cxset
  {
    fashion~image                = fashion-02.jpg,
    subtitle~font-color          = black!95,
    fashion~image~width          = 5cm,
  }
\ExplSyntaxOff

\ExplSyntaxOn
\def\fashionnumberbg {gray!30}
\@debugtrue
\if@debug
   \tikzset{fashion/.style = rectangle, draw}
\else
\fi
\ExplSyntaxOff

\DeclareDocumentCommand \storyi {}
{
  In antiquity men and women saw each other as different;
  accordingly, they developed
  complex taxonomies (philosophical explanations)
  for understanding anatomical,
  physiological, emotional, and rational differences. \par

  Some of these differences seem profoundly odd to us moderns.
  Modern discussions about erotic art have often concerned
  the place of women: to what
  extent are they objects of social manipulation, to what
  extent can they be subjects?
}
\ExplSyntaxOn
\DeclareDocumentCommand \fashion {m m} {%
   \dim_set:Nn \l_tmpa_dim {0pt}
   \ifdim\linewidth<16cm
    \dim_set:Nn \l_tmpa_dim {-2cm}
   \fi
  \hspace*{\dim_use:N \l_tmpa_dim}
     \begin{tikzpicture}[yshift=-5cm,xshift=-2cm]
  \if@debug
    \draw [help~lines,color=black!10] (0,-1) grid (16,-18);
    %\draw[fill=red]  (0,0) circle (1.5pt) ;
    %\draw[fill=red]  (0,-3) circle (1.5pt) ;
  \else
  \fi
  % draw debug rectangles
  \node[fashion, right, baseline] (x) at (0,1) {\LARGE\color{black!30}{}\relax};
  %\draw[fill=red]  (0,1) circle (1.5pt) ;
  \node[fashion, right=1sp] at (0,0)
    {
      %\LARGE\color{black!20} \so\chaptername\relax
    };
\node[rectangle,draw,
      color = thechaptercolor,
      below~left, drop~shadow,
      fill= thechaptercolor,
      text=white,
      ] at +(15,-0.5) {\HHUGE\sffamily\bfseries\color{white}\thechapter};
\node[fashion, text~width=9cm,below~right, yshift=-1pt] at (0,-3)
  {%
        {%
          \sffamily\RaggedRight
          %dis-allow hyphenation
          \language-1
          \Huge\bfseries\color{thechaptercolor}#2\par}
           \bigskip
           \Large%
           \centering
           \color{\__fashion_subtitlefontcolor
         }%
         %\RaggedRight
        \storyi\par
  };
        \IfFileExists{./images/\l__fashion_image}
           {\node[below~left,
                  outer~sep=0pt,
                  inner~sep=0pt,
                  drop~shadow = {
                  shadow~scale=1.0,
                  shadow~xshift=50pt,
                  shadow~yshift=-10pt,
                  fill=white,
                  opacity=0.2},
                  rounded~corners,yshift=2cm,
                  ] at (14.5,-10.5) {\includegraphics[width=\__fashion_image_width]{\l__fashion_image}};}%
           {\node at (12.5,-10.5) {\includegraphics[width=5cm]{./images/venus}};}%
\end{tikzpicture}
\thispagestyle{plain}
\vfill
\newpage
}
\ExplSyntaxOff

\endinput
%%
%% End of file `phd-lowersections.sty'.
