% (C) Copyright Frank Mittelbach, Chris Rowley,
%               Alan Jeffrey and David Carlisle 1993-1998.
% All rights reserved.
% \fi
%
% \CheckSum{1199}
%
% \footnotechanges{v1.0f}{1994/05/22}{Use new warning and error commands}
% \footnotechanges{v1.0l}{1994/11/17}{\cs{@tempa} to \cs{reserved@a}}
% \footnotechanges{v1.0z}{1998/03/21}{Added to documentation of filecontents}
% \footnotechanges{v1.1c}{1998/08/17}{(RmS) Minor documentation fixes.}
\chapter{ltclass}
\label{kernel:ltclass}
\section{Introduction}

 This part of the kernel implements the class and package mechanisms,
 including the handling of options. It replaced the \latex2.09
 |\documentstyle| in  \LaTeXe\ documents. Provisions were made for
 backwards compatibility so that old documents containing |\documentstyle| 
 could still be run using a compatibility option. Backwards compatibility
 has always been one of the primary objectives of the \latex Team making
 \latex an excellent resource for archival purposes.

 The \latexe kernel on its own does not provide the necessary functionality
 to typeset a document. It is a framework upon which classes can define
 the necessary elements and the instructions as to how they are formatted.
 Packages can then be used to extend even further the functionality of the
 classes or even the kernel. Classes and packages can be loaded with options.

 \section{User interface}

 |\documentclass[|\meta{main-option-list}|]{|
   \meta{class}|}[|\meta{version}|]|

 There must be exactly one such declaration, and it must come first.
 The \meta{main-option-list} is a list of options which can modify the
 formatting of elements which are defined in the \meta{class} file
 as well as in all following |\usepackage| declarations (see below).
 The \meta{version} is a version number, beginning with a date in the
 format |YYYY/MM/DD|.  If an older version of the class is found, a
 warning is issued.

 \bigskip

 |\documentstyle[|\meta{main-option-list}|]{|
   \meta{class}|}[|\meta{version}|]|

 The |\documentstyle| declaration is kept in order to maintain upward
 compatibility with \LaTeX2.09 documents.  It is similar to
 |\documentclass|, but it causes all options in
 \meta{main-option-list} that the \meta{class} does not use to be
 passed to |\RequirePackage| after the options have been processed.
 This maintains compatibility with the 2.09 behaviour. Also a flag is
 set to indicate that the document is to be processed in \LaTeX2.09
 compatibility mode.  As far as most packages are concerned, this
 only affects the warnings and errors \LaTeX\ generates. This flag
 does affect the definition of font commands, and |\sloppy|.

 \bigskip

 |\usepackage[|\meta{package-option-list}|]{|^^A
    \meta{package-list}|}[|\meta{version}|]|

 There can be any number of these declarations. All packages in
 \meta{package-list} are called with the same options.

 Each \meta{package} file defines new elements (or modifies those
 defined in the \meta{class}), and thus extends the range of documents
 which can be processed.
 
 The \meta{package-option-list} is a list of options which can modify
 the formatting of elements defined in the \meta{package} file.
 The \meta{version} is a version number, beginning with a date in the
 format |YYYY/MM/DD|.  If an older version of the package is found, a
 warning is issued.

 Each package is loaded only once.  If the same package is requested
 more than once, nothing happens, unless the package has been requested
 with options that were not given the first time it was loaded, in
 which case an error is produced.

 As well as processing the options given in the
 \meta{package-option-list}, each package processes the
 \meta{main-option-list}.  This means that options that affect all
 of the packages can be given globally, rather than repeated for every
 package.

 Note that class files have the extension |.cls|, packages have the
 extension |.sty|.

 The environment \refCom{filecontents} is intended for passing the contents
 of packages, options, or other files along with a document in a
 single file.
 
 It has one argument, which is the name of the file to create. If that
 file already exists (maybe only in the current directory if the OS
 supports a notion of a `current directory' or `default directory')
 then nothing happens
 (except for an information message) and the body of the environment
 is bypassed. Otherwise, the body of the environment is written
 verbatim to the file name given as the first argument, together with
 some comments about how it was produced.

 The environment is allowed only before \refCom{documentclass} to ensure
 that all packages or options necessary for this particular run are
 present when needed.  The begin and end tags should each be on a
 line by itself.  There is also a star-form; this does not write
 extra comments into the file.

 \subsection{Option processing}

 When the options are processed, they are divided into two types: {\em
 local\/} and {\em global}:
 \begin{itemize}

 \item For a class, the options in the |\documentclass| command are
    local.

 \item For a package, the options in the |\usepackage| command are
    local, and the options in the |\documentclass| command are global.

 \end{itemize}
 The options for |\documentclass| and |\usepackage|
 are processed in the following way:
 \begin{enumerate}

 \item The local and global options that have been declared
   (using \refCom{DeclareOption} as  described below) are processed
   first.

  In the case of |\ProcessOptions|, they are processed in the order
  that they were declared in the class or package.

  In the case of |\ProcessOptions*|, they are processed in the order
  that they appear in the option-lists. First the global options, and
  then the local ones.

 \item Any remaining local options are dealt with using the default
   option (declared using the |\DeclareOption*| declaration described
   below).  For document classes, this usually does nothing, but
   records the option on a list of unused options.
   For packages, this usually produces an error.

 \end{enumerate}
 Finally, when |\begin{document}| is reached, if there are any global
 options which have not been used by either the class or any package,
 the system will produce a warning.


 \section{Class and Package interface}

 \subsection{Class name and version}


 A class can identify itself with the
 \refCom{ProvidesClass}|{|\meta{name}|}[|\meta{version}|]| command.  The
 \meta{version} should begin with a date in the format |YYYY/MM/DD|.

 \subsection{Package name and version}


 A package can identify itself with the
 \refCom{ProvidesPackage}\marg{name}\oarg{version} command.  The
 \meta{version} should begin with a date in the format |YYYY/MM/DD|.

 \subsection{Requiring other packages}

 Packages or classes can load other packages using\\
\refCom{RequirePackage}\oarg{options}\marg{name}\oarg{version}.\\
 If the package has already been loaded, then nothing happens unless
 the requested options are not a subset of the options with which it
 was loaded, in which case an error is called.

 \refCom{LoadClass}
 is similar to |\RequirePackage|, but for classes, may not be used in
  package files.

 \DescribeMacro\PassOptionsToPackage
 Packages can pass options to other packages using:\\
 |\PassOptionsToPackage{|\meta{options}|}{|\meta{package}|}|.\\
 
 \DescribeMacro\PassOptionsToClass
 This adds the \meta{options} to the options list of any future
 |\RequirePackage| or |\usepackage| command.  For example:
 \begin{verbatim}
    \PassOptionsToPackage{foo,bar}{fred}
    \RequirePackage[baz]{fred}\end{verbatim}
 is the same as:
 \begin{verbatim}
    \RequirePackage[foo,bar,baz]{fred}\end{verbatim}

 
 \cs{LoadClassWithOptions}\marg{name}\oarg{version}:\\
 This is similar to
 |\LoadClass|, but it always calls class \meta{name} with
 exactly the same option list that is being used by the current class,
 rather than an option explicitly  supplied or passed on by
 |\PassOptionsToClass|.
 
 
 \refCom{RequirePackageWithOptions} is the analogous command for packages.

 This is mainly intended to allow one class to simply build on another,
 for example:
\begin{verbatim}
   \LoadClassWithOptions{article}
\end{verbatim}

 This should be contrasted with the slightly different construction
\begin{verbatim}
   \DeclareOption*{\PassOptionsToClass{\CurrentOption}{article}}
   \ProcessOptions
   \LoadClass{article}
\end{verbatim}

 As used here, the effects are more or less the same, but the
 version using |\LoadClassWithOptions| is slightly quicker
 (and less to type).
 If, however, the class declares options of its own then
 the two constructions are different; compare, for example:
\begin{verbatim}
   \DeclareOption{landscape}{...}
   \ProcessOptions
   \LoadClassWithOptions{article}
\end{verbatim}
 with:
\begin{verbatim}
   \DeclareOption{landscape}{...}
   \DeclareOption*{\PassOptionsToClass{\CurrentOption}{article}}
   \ProcessOptions
   \LoadClass{article}
\end{verbatim}
 In the first case, the \textsf{article} class will be called with
 option |landscape| precisely when the current class is called with
 this option; but in the second example it will
 not as in that case \textsf{article} is only passed options by the
 default option handler, which is not used for |landscape| as that
 option is explicitly declared.


\begin{docCommands}
 \refCom{@ifpackageloaded}
 To find out if a package has already been loaded.

 \refCom{@ifclassloaded} To find out if a class has already been loaded.
 
 \refCom{@ifpackageloaded}{\marg{\meta{package}}\marg{\meta{true}}\marg{\meta{false}}}
 To find out if a package has been loaded.

 \refCom{@ifpackagelater}
 \footnotechanges{v1.1i}{2013/07/07}{Correctly describe how the date in
       \cs{@ifpackagelater} is used}
 To find out if a package has already been loaded with a version
 equal to or more  recent than \meta{version}.
 
 \refCom{@ifclasslater}
 |\@ifpackagelater{|\meta{package}|}{|\meta{version}|}{|%
 \meta{true}|}{|\meta{false}|}|.

 \refCom{@ifpackagewith}
 To find out if a package has already been loaded with at least the
 options \meta{options}, use
 
 \refCom{@ifclasswith}
 |\@ifpackagewith{|\meta{package}|}{|\meta{options}|}{|%
 \meta{true}|}{|\meta{false}|}|.
\end{docCommands}

 There exists one package that can't be tested with the above
 commands: the \texttt{fontenc} package pretends that it was never
 loaded to allow for repeated reloading with different options (see
 \texttt{ltoutenc.dtx} for details).
 


 \subsection{Declaring new options}

 Options for classes and packages are built using the same macros.

\begin{docCommands}  

 \refCom{DeclareOption}|{|\meta{name}|}{|\meta{code}|}|. To define a builtin option, use

 \refCom{DeclareOption*} To define the default action to
 perform for local options which have not been declared, use
 |\DeclareOption*{|\meta{code}|}|.

 {\em Note\/}: there should be no use of\\
  |\RequirePackage|, |\DeclareOption|, |\DeclareOption*| or
   |\ProcessOptions|\\
 inside |\DeclareOption| or |\DeclareOption*|.

 Possible uses for |\DeclareOption*| include:

 \refCom{DeclareOption*}{\meta{}}
    Do nothing. Silently accept unknown options. (This suppresses the
    usual warnings.)

 |\DeclareOption*{\@unkownoptionerror}|\\
     Complain about unknown local options. (The initial setting for
       package files.)

 |\DeclareOption*{\PassOptionsToPackage{\CurrentOption}|^^A
                                     |{|\meta{pkg-name}|}|\\
 Handle the the current option by passing it on to the package
 \meta{pkg-name}, which will presumably be loaded via
 |\RequirePackage| later in the file. This is useful for building
 `extension' packages, that perhaps handle a couple of new options,
 but then pass everything else on to an existing package.

 |\DeclareOption*{\InputIfFileExists{xx-\CurrentOption.yyy}%|\\
 |               {}%|\\
 |               {\OptionNotUsed}}|\\
 
  Handle the option foo by loading the file |xx-foo.yyy| if it
  exists, otherwise do nothing, but declare that the option was not
  used.
  Actually the \refCom{OptionNotUsed} declaration is only needed if this is
  being used in class files, but does no harm in package files.
\end{docCommands}

 \subsection{Safe Input Macros}
 

 \refCom{InputIfFileExists}|{|\meta{file}|}{|\meta{then}|}{|\meta{else}|}|\\
 Inputs \meta{file} if it exists. Immediately before the input,
 \meta{then} is executed. Otherwise \meta{else} is executed. Note that these
 macros are not defined in this file, but rather in the |ltfiles| module (see Chapter~\ref{ch:ltfiles}).

 \refCom{IfFileExists} is similar to the above, but does not input the file.

 One thing you might like to put in the \meta{else} clause is
 \refCom{@missingfileerror}
 This starts an interactive request for a filename, supplying default
 extensions. Just hitting return causes the whole input to be skipped
 and entering |x| quits the current run,

 \refCom{input}
 This has been redefined from the \LaTeX2.09 definition, in terms of
 the new commands |\InputIfFileExists| and |\@missingfileerror|.


 \refCmd{listfiles} Giving this declaration in the preamble
 causes a list of all files input via the `safe input' commands to be
 listed at the end. Any strings specified in the optional argument to
 
 \refCmd{ProvidesPackage} are listed alongside the file name. So files in
 standard (and other non-standard) distributions can put informative
 strings in this argument.


\section{Implementation}
%
\begin{teX}
%<*2ekernel>
\end{teX}
%
%
% \footnotechanges{v0.2g}{1993/11/23}
%         {Various macros now moved to latex.tex.}
% \footnotechanges{v0.2g}{1993/11/23}
%         {Warnings and errors now directly coded.}
% \footnotechanges{v0.2h}{1993/11/28}
%         {Primitive filenames now terminated by space not \cs{relax}.}
% \footnotechanges{v0.2h}{1993/11/28}
%         {Directory syntax checing moved to dircheck.dtx}
% \footnotechanges{v0.2h}{1993/11/28}
%         {Assorted commands now in the kernel removed.}
% \footnotechanges{v0.2i}{1993/12/03}
%         {\cs{@onlypreamble}: Many commands declared.}
% \footnotechanges{v0.2i}{1993/12/03}
%         {Removed obsolete \cs{@documentclass}}
% \footnotechanges{v0.2o}{1993/12/13}
%         {Removed setting \cs{errorcontextlines}\ (now in latex.tex)}
% \footnotechanges{v0.2p}{1993/12/15}
%         {Removed extra `.'s from \cs{@@warning}s}
% \footnotechanges{v0.2s}{1994/01/17}
%         {Added many more \cs{@onlypreamble} commands}
% \footnotechanges{v0.2s}{1994/01/17}
%         {Wrapped long lines to column 72}
% \footnotechanges{v0.3a}{1994/03/02}
%         {Remove need for driver file}
% \footnotechanges{v0.3b}{1994/03/08}
%         {Modify driver code into `new style'}
% \footnotechanges{v0.3c}{1994/03/12}
%         {Change name from docclass to ltclass}
% \footnotechanges{v0.3h}{1994/04/25}
%         {Removed spurious extra `.'s at the end of error messages}
% \footnotechanges{v1.0a}{1994/04/29}
%         {Change version number to 1 (no other change)}
% \footnotechanges{v1.0k}{1994/11/03}
%         {Move \cs{@missingfileerror} to ltfiles}
%
\begin{docCmd}{if@compatibility}{}
%    The flag for compatibility mode.
\begin{teX}
\newif\if@compatibility
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@documentclasshook}{}
%    The hook called after the first |\documentclass| command.  By
%    default this checks to see if |\@normalsize| is undefined, and if
%    so, sets it to |\normalsize|.
% \footnotechanges{v0.2q}{1993/12/17}
%         {Macro added}
% \footnotechanges{v0.2z}{1994/02/10}
%         {Changed the name from \cs{@compatibility} to
%          \cs{@documentclasshook}, and added the check for whether
%          \cs{@normalsize} has been defined.  ASAJ.}
\begin{teX}
\def\@documentclasshook{%
   \ifx\@normalsize\@undefined
      \let\@normalsize\normalsize
   \fi
}
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@declaredoptions}{}
    This list is automatically built by |\DeclareOption|.
    It is the list of options (separated by commas) declared in
    the class or package file and it defines the order in which the
    the corresponding |\ds@|\meta{option} commands are executed.
    All local \meta{option}s which are not declared will be processed
    in the order defined by the optional argument of |\documentclass|
    or |\usepackage|.
\begin{teX}
\let\@declaredoptions\@empty
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@classoptionslist}{}
%    List of options of the main class.
% \footnotechanges{v1.0u}{1996/07/26}{made only preamble}
\begin{teX}
\let\@classoptionslist\relax
\@onlypreamble\@classoptionslist
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@unusedoptionlist}{}
% \footnotechanges{v1.0u}{1996/07/26}{made only preamble}
%    List of options of the main class that haven't been declared or
%    loaded as class option files.
\begin{teX}
\let\@unusedoptionlist\@empty
\@onlypreamble\@unusedoptionlist
\end{teX}
\end{docCmd}
%
\begin{docCmd}{CurrentOption}{}
    Name of current package or option.
% \footnotechanges{v0.2c}{1993/11/17}
%         {Name changed from \cs{@curroption}}
\begin{teX}
\let\CurrentOption\@empty
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@currname}{}
 Name of current package or option.
\begin{teX}
\let\@currname\@empty
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@currext}{}
%    The current file extension.
% \footnotechanges{v0.2a}{1993/11/14}{Name changed from \cs{@currextension}}
\begin{teX}
\global\let\@currext=\@empty
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@clsextension}{}
\begin{docCmd}{@pkgextension}{}
%    The two possible values of |\@currext|.
\begin{teX}
\def\@clsextension{cls}
\def\@pkgextension{sty}
\@onlypreamble\@clsextension
\@onlypreamble\@pkgextension
\end{teX}
\end{docCmd}
\end{docCmd}
%
\begin{docCmd}{@pushfilename}{}
\begin{docCmd}{@popfilename}{}
\begin{docCmd}{@currnamestack}{}
 Commands to push and pop the file name and extension. \\
 |#1| current name.      \\
 |#2| current extension. \\
 |#3| current catcode of |@|. \\
 |#4| Rest of the stack.
\begin{teX}
\def\@pushfilename{%
  \xdef\@currnamestack{%
    {\@currname}%
    {\@currext}%
    {\the\catcode`\@}%
    \@currnamestack}}
\@onlypreamble\@pushfilename
\end{teX}
%
\begin{teX}
\def\@popfilename{\expandafter\@p@pfilename\@currnamestack\@nil}
\@onlypreamble\@popfilename
\end{teX}
%
\begin{teX}
\def\@p@pfilename#1#2#3#4\@nil{%
  \gdef\@currname{#1}%
  \gdef\@currext{#2}%
  \catcode`\@#3\relax
  \gdef\@currnamestack{#4}}
\@onlypreamble\@p@pfilename
\end{teX}
%
\begin{teX}
\gdef\@currnamestack{}
\@onlypreamble\@currnamestack
\end{teX}
\end{docCmd}
\end{docCmd}
\end{docCmd}
%
\begin{docCmd}{@ptionlist}{}
%    Returns the option list of the file.
\begin{teX}
\def\@ptionlist#1{%
  \@ifundefined{opt@#1}\@empty{\csname opt@#1\endcsname}}
\@onlypreamble\@ptionlist
\end{teX}
\end{docCmd}
%
The following two commands check to see if a class or a package has been loaded.
The test is done by checking that |ver@pkgname.sty| or |ver@classname.cls| are defined. The test
is carried comparing to |\relax|.

\begin{docCmd}{@ifpackageloaded}{ \meta{package name}\meta{true code}\meta{false code}}
\end{docCmd}
\begin{docCmd}{@ifclassloaded}{ \meta{class name}\meta{true code}\meta{false code}}
   |\@ifpackageloaded{|\meta{name}|}|
  Checks to see whether a file has been loaded.
% \footnotechanges{v0.2t}{1994/01/18}
%         {Fix typo \cs{@pkgetension}}
\begin{teX}
\def\@ifpackageloaded{\@ifl@aded\@pkgextension}
\def\@ifclassloaded{\@ifl@aded\@clsextension}
\@onlypreamble\@ifpackageloaded
\@onlypreamble\@ifclassloaded
\end{teX}
%
\begin{teX}
\def\@ifl@aded#1#2{%
  \expandafter\ifx\csname ver@#2.#1\endcsname\relax
    \expandafter\@secondoftwo
  \else
    \expandafter\@firstoftwo
  \fi}
\@onlypreamble\@ifl@aded
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@ifpackagelater}{}
\begin{docCmd}{@ifclasslater}{}
% |\@ifpackagelater{|\meta{name}|}{YYYY/MM/DD}|
% Checks that the package loaded is more recent than the given date.
\begin{teX}
\def\@ifpackagelater{\@ifl@ter\@pkgextension}
\def\@ifclasslater{\@ifl@ter\@clsextension}
\@onlypreamble\@ifpackagelater
\@onlypreamble\@ifclasslater
\end{teX}
%
\begin{teX}
\def\@ifl@ter#1#2{%
  \expandafter\@ifl@t@r
    \csname ver@#2.#1\endcsname}
\@onlypreamble\@ifl@ter
\end{teX}
%
% This internal macro is also used in |\NeedsTeXFormat|.
% \footnotechanges{v0.2f}{1993/11/22}
%         {Added //00 so parsing never produces a runaway argument.}
\begin{teX}
\def\@ifl@t@r#1#2{%
  \ifnum\expandafter\@parse@version#1//00\@nil<%
        \expandafter\@parse@version#2//00\@nil
    \expandafter\@secondoftwo
  \else
    \expandafter\@firstoftwo
  \fi}
\@onlypreamble\@ifl@t@r
\end{teX}
%
\begin{teX}
\def\@parse@version#1/#2/#3#4#5\@nil{#1#2#3#4 }
\@onlypreamble\@parse@version
\end{teX}
\end{docCmd}
\end{docCmd}
%
\begin{docCmd}{@ifpackagewith}{}
\begin{docCmd}{@ifclasswith}{}
% |\@ifpackagewith{|\meta{name}|}{|\meta{option-list}|}|
% Checks that \meta{option-list} is a subset of the options
% \textbf{with} which \meta{name} was loaded.
\begin{teX}
\def\@ifpackagewith{\@if@ptions\@pkgextension}
\def\@ifclasswith{\@if@ptions\@clsextension}
\@onlypreamble\@ifpackagewith
\@onlypreamble\@ifclasswith
\end{teX}
%
\begin{teX}
\def\@if@ptions#1#2{%
  \@expandtwoargs\@if@pti@ns{\@ptionlist{#2.#1}}}
\@onlypreamble\@if@ptions
\end{teX}
%
% Probably shouldn't use |\CurrentOption| here\ldots (changed to
% |\reserved@b|.)
% \footnotechanges{v0.2y}{1994/02/07}
%         {Add extra ,s so `two' is not matched with `twocolumn'}
% \footnotechanges{v1.1i}{2011/08/19}
%         {Re-jig definition after more stringent \cs{in@} test.}
\begin{teX}
\def\@if@pti@ns#1#2{%
 \let\reserved@a\@firstoftwo
 \@for\reserved@b:=#2\do{%
   \ifx\reserved@b\@empty
   \else
     \expandafter\in@\expandafter{\expandafter,\reserved@b,}{,#1,}%
     \ifin@
     \else
       \let\reserved@a\@secondoftwo
     \fi
   \fi
 }%
 \reserved@a}
\@onlypreamble\@if@pti@ns
\end{teX}
\end{docCmd}
\end{docCmd}
%
\begin{docCmd}{ProvidesPackage}{}
 Checks that the current filename is correct, and defines
    |\ver@filename|.
% \footnotechanges{v0.3c}{1994/03/12}
%         {Add \cs{wlog}}
% \footnotechanges{v0.3c}{1994/03/12}
%         {use \cs{@gtempa}}
\begin{teX}
\def\ProvidesPackage#1{%
  \xdef\@gtempa{#1}%
  \ifx\@gtempa\@currname\else
    \@latex@warning@no@line{You have requested
      \@cls@pkg\space`\@currname',\MessageBreak
       but the \@cls@pkg\space provides `#1'}%
  \fi
  \@ifnextchar[\@pr@videpackage{\@pr@videpackage[]}}%]
\@onlypreamble\ProvidesPackage
\end{teX}
%
\begin{teX}
\def\@pr@videpackage[#1]{%
  \expandafter\xdef\csname ver@\@currname.\@currext\endcsname{#1}%
  \ifx\@currext\@clsextension
    \typeout{Document Class: \@gtempa\space#1}%
  \else
    \wlog{Package: \@gtempa\space#1}%
  \fi}
\@onlypreamble\@pr@videpackage
\end{teX}
\end{docCmd}
%
\begin{docCmd}{ProvidesClass}{}
%    Like |\ProvidesPackage|, but for classes.
\begin{teX}
\let\ProvidesClass\ProvidesPackage
\@onlypreamble\ProvidesClass
\end{teX}
\end{docCmd}
%
\begin{docCmd}{ProvidesFile}{}
%    Like |\ProvidesPackage|, but for arbitrary files. Do not apply
%    |\@onlypreamble| to these, as we may want to label files input
%    during the document.
% \footnotechanges{v0.2l}{1993/12/07}
%         {Macro added}
% \footnotechanges{v0.3c}{1994/03/12}
%         {Add \cs{wlog}}
% \footnotechanges{v0.3g}{1994/04/11}
%         {Protect against weird catcodes.}
\begin{docCmd}{@providesfile}{}
% \footnotechanges{v1.0r}{1995/10/17}
%         {Delay definition of \cs{ProvidesFile} till ltfinal}
% \footnotechanges{v1.1a}{1998/03/21}
%         {Allow \&. Internal/2702}
% \footnotechanges{v1.1d}{2001/05/25}{Explicitly set catcode of
%                              \cs{endlinechar} to 10 (pr/3334)}
% \footnotechanges{v1.1e}{2001/06/04}{But only if it is a char (pr/3334)}
% \footnotechanges{v1.1f}{2001/08/26}{Readded setting of space char (pr/3353)}
\begin{teX}
\def\ProvidesFile#1{%
  \begingroup
    \catcode`\ 10 %
    \ifnum \endlinechar<256 %
      \ifnum \endlinechar>\m@ne
        \catcode\endlinechar 10 %
      \fi
    \fi
    \@makeother\/%
    \@makeother\&%
\end{teX}
% \footnotechanges{v1.1g}{2004/01/28}{Use kernel version of
%                             \cs{@ifnextchar} (pr/3501)}
\begin{teX}
    \kernel@ifnextchar[{\@providesfile{#1}}{\@providesfile{#1}[]}}
\end{teX}
%
% During initex a special version of |\@providesfile| is used.
% The real definition is installed right at the end, in |ltfinal.dtx|.
%\begin{verbatim}
%\def\@providesfile#1[#2]{%
%    \wlog{File: #1 #2}%
%    \expandafter\xdef\csname ver@#1\endcsname{#2}%
%  \endgroup}
\
%\end{verbatim}
\end{docCmd}
\end{docCmd}

\section{Passing Options}

 With the basic commands behind us, the passing of options to a package or class is done
 through two commands |\PassOptionsToPackage| and |\PassOptionsToClass|.

\begin{docCmd}{PassOptionsToPackage}{}
\end{docCmd}
\begin{docCmd}{PassOptionsToClass}{}

 If the package has been loaded, we check that it was first loaded with
 the options.  Otherwise we add the option list to that of the package.
\end{docCmd}
%
 
\begin{teX}
\def\@pass@ptions#1#2#3{%
  \expandafter\xdef\csname opt@#3.#1\endcsname{%
    \@ifundefined{opt@#3.#1}\@empty
      {\csname opt@#3.#1\endcsname,}%
    \zap@space#2 \@empty}}
\@onlypreamble\@pass@ptions
\end{teX}
%
\begin{teX}
\def\PassOptionsToPackage{\@pass@ptions\@pkgextension}
\def\PassOptionsToClass{\@pass@ptions\@clsextension}
\@onlypreamble\PassOptionsToPackage
\@onlypreamble\PassOptionsToClass
\end{teX}


\section{Declaring Options}
 Options are declared using the |DeclareOption| command.
\begin{docCmd}{DeclareOption}{}
\end{docCmd}
\begin{docCmd}{DeclareOption*}{}
\end{docCmd}
Adds an option as a |\ds@| command, or the default |\default@ds|
    command.
% \footnotechanges{v0.2c}{1993/11/17}
%         {Error checking added}
% \footnotechanges{v1.0m}{1995/04/21}
%         {Made long /1498}
% \footnotechanges{v1.0n}{1995/05/12}
%         {Use \cs{toks@} to remove need to double hash /1557}
\begin{teX}
\def\DeclareOption{%
  \let\@fileswith@pti@ns\@badrequireerror
  \@ifstar\@defdefault@ds\@declareoption}
  
\long\def\@declareoption#1#2{%
   \xdef\@declaredoptions{\@declaredoptions,#1}%
   \toks@{#2}%
   \expandafter\edef\csname ds@#1\endcsname{\the\toks@}}
   
\long\def\@defdefault@ds#1{%
  \toks@{#1}%
  \edef\default@ds{\the\toks@}}
  
\@onlypreamble\DeclareOption
\@onlypreamble\@declareoption
\@onlypreamble\@defdefault@ds
\end{teX}


%
\begin{docCmd}{OptionNotUsed}{}
% If we are in a class file, add |\CurrentOption| to the list of
% unused options. Otherwise, in a package file do nothing.
\begin{teX}
\def\OptionNotUsed{%
  \ifx\@currext\@clsextension
    \xdef\@unusedoptionlist{%
      \ifx\@unusedoptionlist\@empty\else\@unusedoptionlist,\fi
      \CurrentOption}%
  \fi}
\@onlypreamble\OptionNotUsed
\end{teX}
\end{docCmd}
%
\begin{docCmd}{default@ds}{}
% The default default option code.
% Set by |\@onefilewithoptions| to either |\OptionNotUsed| for
% classes, or |\@unknownoptionerror| for packages. This may be reset
% in either case with |\DeclareOption*|.
\begin{teX}
% \let\default@ds\OptionNotUsed
\end{teX}
\end{docCmd}
%
\begin{docCmd}{ProcessOptions}{}
\begin{docCmd}{ProcessOptions*}{}
 |\ProcessOptions| calls |\ds@option| for each known package option,
 then calls |\default@ds| for each option on the local options list.
 Finally resets all the declared options to |\relax|. The empty option
 does nothing, this has to be reset on the off chance it's set to
 |\relax| if an empty element gets into the |\@declaredoptions| list.

 The star form is similar but executes options given in the order
 specified in the document, not the order they are declared in the
 file. In the case of packages, global options are executed before
 local ones.
% \footnotechanges{v0.2a}{1993/11/14}
%         {Stop adding the global option list inside class files.}
% \footnotechanges{v0.2a}{1993/11/14}
%         {Optimise `empty option' code.}
% \footnotechanges{v0.2b}{1993/11/15}
%         {Star form added.}
% \footnotechanges{v0.2c}{1993/11/17}
%         {restoring \cs{@fileswith@pti@ns} added.}
\begin{teX}
\def\ProcessOptions{%
  \let\ds@\@empty
  \edef\@curroptions{\@ptionlist{\@currname.\@currext}}%
  \@ifstar\@xprocess@ptions\@process@ptions}
\@onlypreamble\ProcessOptions
\end{teX}
%
% \footnotechanges{v0.2y}{1994/02/07}
%         {Add extra ,s so `two' is not matched with `twocolumn'}
\begin{teX}
\def\@process@ptions{%
  \@for\CurrentOption:=\@declaredoptions\do{%
    \ifx\CurrentOption\@empty\else
      \@expandtwoargs\in@{,\CurrentOption,}{%
         ,\ifx\@currext\@clsextension\else\@classoptionslist,\fi
         \@curroptions,}%
      \ifin@
        \@use@ption
        \expandafter\let\csname ds@\CurrentOption\endcsname\@empty
      \fi
    \fi}%
  \@process@pti@ns}
\@onlypreamble\@process@ptions
\end{teX}
%
% \footnotechanges{v0.2y}{1994/02/07}
%         {Add extra ,s so `two' is not matched with `twocolumn'}
\begin{teX}
\def\@xprocess@ptions{%
  \ifx\@currext\@clsextension\else
    \@for\CurrentOption:=\@classoptionslist\do{%
      \ifx\CurrentOption\@empty\else
        \@expandtwoargs\in@{,\CurrentOption,}{,\@declaredoptions,}%
        \ifin@
          \@use@ption
          \expandafter\let\csname ds@\CurrentOption\endcsname\@empty
        \fi
      \fi}%
  \fi
  \@process@pti@ns}
\@onlypreamble\@xprocess@ptions
\end{teX}

 The common part of |\ProcessOptions| and |\ProcessOptions*|.
\begin{teX}
\def\@process@pti@ns{%
  \@for\CurrentOption:=\@curroptions\do{%
    \@ifundefined{ds@\CurrentOption}%
      {\@use@ption
       \default@ds}%
\end{teX}
 There should not be any non-empty definition of |\CurrentOption| at
 this point, as all the declared options were executed earlier. This is
 for compatibility with 2.09 styles which use |\def\ds@|\ldots\
 directly, and so have options which do not appear in
 |\@declaredoptions|.
\begin{teX}
      \@use@ption}%
\end{teX}
 Clear all the definitions for option code. First set all the declared
 options to |\relax|, then reset the `default' and `empty' options. and
 the lst of declared options.
\begin{teX}
  \@for\CurrentOption:=\@declaredoptions\do{%
    \expandafter\let\csname ds@\CurrentOption\endcsname\relax}%
\end{teX}
% \footnotechanges{v1.0r}{1995/10/17}
%         {Reset \cs{CurrentOption} for graphics/1873}
\begin{teX}
  \let\CurrentOption\@empty
  \let\@fileswith@pti@ns\@@fileswith@pti@ns
  \AtEndOfPackage{\let\@unprocessedoptions\relax}}
\@onlypreamble\@process@pti@ns
\end{teX}
\end{docCmd}
\end{docCmd}
%
\begin{docCmd}{@options}{}
% |\@options| is a synonym for |\ProcessOptions*| for upward
% compatibility with \LaTeX2.09 style files.
\begin{teX}
\def\@options{\ProcessOptions*}
\@onlypreamble\@options
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@use@ption}{}
% Execute the code for the current option.
% \footnotechanges{v0.2g}{1993/11/23}
%         {Name changed from \cs{@executeoption}}
% \footnotechanges{v1.0e}{1994/05/17}
%         {Execute option after removing from list, not before}
\begin{teX}
\def\@use@ption{%
  \@expandtwoargs\@removeelement\CurrentOption
  \@unusedoptionlist\@unusedoptionlist
  \csname ds@\CurrentOption\endcsname}
\@onlypreamble\@use@ption
\end{teX}
\end{docCmd}
%
\begin{docCmd}{ExecuteOptions}{}
% |\ExecuteOptions{|\meta{option-list}|}| executes the code declared
% for each option.
% \footnotechanges{v0.2d}{1993/11/18}
%         {Use \cs{CurrentOption} not \cs{reserved@a}}
% \footnotechanges{v0.2k}{1993/12/06}
%         {Preserve \cs{CurrentOption}.}
\begin{teX}
\def\ExecuteOptions#1{%
  \def\reserved@a##1\@nil{%
    \@for\CurrentOption:=#1\do{\csname ds@\CurrentOption\endcsname}%
    \edef\CurrentOption{##1}}%
  \expandafter\reserved@a\CurrentOption\@nil}
\@onlypreamble\ExecuteOptions
\end{teX}
\end{docCmd}
%
 The top-level commands, which just set some parameters then call
 the internal command, |\@fileswithoptions|.
 \begin{docCmd}{documentclass}{}
% \footnotechanges{v1.0q}{1995/06/19}
%         {Dont redefine \cs{usepackage} in compat mode for /1634}
 The main new-style class declaration.
\begin{teX}
\def\documentclass{%
  \let\documentclass\@twoclasseserror
  \if@compatibility\else\let\usepackage\RequirePackage\fi
  \@fileswithoptions\@clsextension}
\@onlypreamble\documentclass
\end{teX}
\end{docCmd}
%
\begin{docCmd}{documentstyle}{}
% 2.09 style class `style' declaration.
% \footnotechanges{v0.2a}{1993/11/14}
%         {Added \cs{RequirePackage} \cs{@unusedoptionlist} stuff.}
% \footnotechanges{v0.2b}{1993/11/15}
%         {Modified to match \cs{ProcessOption*}}
% \footnotechanges{v0.2d}{1993/11/18}
%         {Modified \cs{RequirePackage} stuff.}
% \footnotechanges{v0.2n}{1993/12/09}
%         {input 209 compatibility file.}
% \footnotechanges{v0.2o}{1993/12/13}
%         {compatibility file now latex209.sty.}
% \footnotechanges{v0.2q}{1993/12/17}
%         {Match Alan's new code.}
% \footnotechanges{v0.2u}{1994/01/21}
%         {compatibility file now latex209.def.}
\begin{teX}
\def\documentstyle{%
  \makeatletter\input{latex209.def}\makeatother
  \documentclass}
\@onlypreamble\documentstyle
\end{teX}
\end{docCmd}
%
\begin{docCmd}{RequirePackage}{}
% Load package if not already loaded.
\begin{teX}
\def\RequirePackage{%
  \@fileswithoptions\@pkgextension}
\@onlypreamble\RequirePackage
\end{teX}
\end{docCmd}
%

\begin{docCmd}{LoadClass}{}
% Load class.
\begin{teX}
\def\LoadClass{%
  \ifx\@currext\@pkgextension
     \@latex@error
      {\noexpand\LoadClass in package file}%
      {You may only use \noexpand\LoadClass in a class file.}%
  \fi
  \@fileswithoptions\@clsextension}
\@onlypreamble\LoadClass
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@loadwithoptions}{}
% \footnotechanges{v1.0t}{1995/11/14}{macro added}
% Pass the current option list on to a class or package.
% |#1| is |\@|\emph{cls-or-pkg}|extension|,
% |#2| is |\RequirePackage| or |\LoadClass|,
% |#3| is the class or package to be loaded.
\begin{teX}
\def\@loadwithoptions#1#2#3{%
  \expandafter\let\csname opt@#3.#1\expandafter\endcsname
       \csname opt@\@currname.\@currext\endcsname
   #2{#3}}
\@onlypreamble\@loadwithoptions
\end{teX}
\end{docCmd}
%
%
\begin{docCmd}{LoadClassWithOptions}{}
% \footnotechanges{v1.0t}{1995/11/14}{macro added}
% Load class `|#1|' with the current option list.
\begin{teX}
\def\LoadClassWithOptions{%
  \@loadwithoptions\@clsextension\LoadClass}
\@onlypreamble\LoadClassWithOptions
\end{teX}
\end{docCmd}
%
\begin{docCmd}{RequirePackageWithOptions}{}
% \footnotechanges{v1.0t}{1995/11/14}{macro added}
% \footnotechanges{v1.0v}{1996/10/04}{Reset \cs{@unprocessedoptions} for /2269}
% Load package `|#1|' with the current option list.
\begin{teX}
\def\RequirePackageWithOptions{%
  \AtEndOfPackage{\let\@unprocessedoptions\relax}%
  \@loadwithoptions\@pkgextension\RequirePackage}
\@onlypreamble\RequirePackageWithOptions
\end{teX}
\end{docCmd}
%
\begin{docCmd}{usepackage}{}
%    To begin with, |\usepackage| produces an error.  This is reset by
%    |\documentclass|.
% \footnotechanges{v0.2o}{1993/12/13}
%         {Fixed error handling}
% \footnotechanges{v1.0h}{1994/05/23}{Remove argument if possible}
\begin{teX}
\def\usepackage#1#{%
  \@latex@error
    {\noexpand \usepackage before \string\documentclass}%
    {\noexpand \usepackage may only appear in the document
      preamble, i.e.,\MessageBreak
      between \noexpand\documentclass and
      \string\begin{document}.}%
  \@gobble}
\@onlypreamble\usepackage
\end{teX}
\end{docCmd}

\begin{docCmd}{NeedsTeXFormat}{ \marg{format name}\oarg{version}}
 Check that the document is running on the correct system. The command
 checks first that the format that is proceesing the file is the same
 as that requested by the argument to |\NeedsTeXFormat| and if it passes
 it calls \refCom{@needsformat} to process the argument in square brackets.
\footnotechanges{v0.2a}{1993/11/14}
         {made more robust for alternative syntax for other formats.}
 \footnotechanges{v0.2c}{1993/11/17}
         {Name changed from \cs{NeedsFormat}}
 \footnotechanges{v0.2d}{1993/11/18}
         {\cs{fmtname} \cs{fmtversion} not \cs{@}\ldots}
\begin{teX}
\def\NeedsTeXFormat#1{%
  \def\reserved@a{#1}%
  \ifx\reserved@a\fmtname
    \expandafter\@needsformat
  \else
     \@latex@error{This file needs format `\reserved@a'%
       \MessageBreak but this is `\fmtname'}{%
       The current input file will not be processed
       further,\MessageBreak
       because it was written for some other flavor of
       TeX.\MessageBreak\@ehd}%
\end{teX}
    If the file is not meant to be processed by \LaTeXe{} 
    inputting is stopped, without ending the run. It just ends inputting
    the current file.\footnotechanges{v1.0h}{1994/05/23}
    {Don't stop completely when format is wrong}
\begin{teX}
     \endinput \fi}
\@onlypreamble\NeedsTeXFormat
\end{teX}
%
\begin{docCmd}{@needsformat}{}
As described earlier |\@needsformat| process the `[]' by first checking it is
available and then calling |\@needsf@rmat|. The latter compares the release
and issues a warning if the version is not available and an earlier one is
being used.
\end{docCmd}
\begin{teX}
\def\@needsformat{%
  \@ifnextchar[%]
    \@needsf@rmat
    {}}
\@onlypreamble\@needsformat
\end{teX}
%
% \footnotechanges{v1.0b}{1994/05/04}
%         {Changed wording of the warning}
\begin{teX}
\def\@needsf@rmat[#1]{%
    \@ifl@t@r\fmtversion{#1}{}%
    {\@latex@warning@no@line
        {You have requested release `#1' of LaTeX,\MessageBreak
         but only release `\fmtversion' is available}}}
\@onlypreamble\@needsf@rmat
\end{teX}
\end{docCmd}
%
\begin{docCmd}{zap@space}{}
 |\zap@space foo|\meta{space}|\@empty| removes all spaces from |foo|
 that are not protected by |{ }| groups.
\begin{teX}
\def\zap@space#1 #2{%
  #1%
  \ifx#2\@empty\else\expandafter\zap@space\fi
  #2}
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@fileswithoptions}{}
 The common part of |\documentclass| and |\usepackage|. This is the most important
 part of the code, since when you say |\documentclass| it will start processing the
 document. 
\begin{teX}
\def\@fileswithoptions#1{%
  \@ifnextchar[%]
    {\@fileswith@ptions#1}%
    {\@fileswith@ptions#1[]}}
\@onlypreamble\@fileswithoptions
\end{teX}
Chages \footnotechanges{v0.2f}{1993/11/22}
         {Made the default [] not [\cs{@unknownversion}]}
 \footnotechanges{v1.1h}{2007/08/05}
         {Prevent loss of brackets PR/3965}
\begin{teX}
\def\@fileswith@ptions#1[#2]#3{%
  \@ifnextchar[%]
  {\@fileswith@pti@ns#1[{#2}]#3}%
  {\@fileswith@pti@ns#1[{#2}]#3[]}}
\@onlypreamble\@fileswith@ptions
\end{teX}
 Then we do some work.

 First of all, we define the global variables.
 Then we look to see if the file has already been loaded.
 If it has, we check that it was first loaded with at least the current
 options.
 If it has not, we add the current options to the package options,
 set the default version to be |0000/00/00|, and load the file if we
 can find it.
 Then we check the version number.

 Finally, we restore the old file name, reset the default option,
 and we set the catcode of |@|.

 For classes, we can immediately process the file. For other types,
 |#2| could be a comma separated list, so loop through, processing
 each one separately.
 \footnotechanges{v0.2q}{1993/12/17}
         {Add \cs{@compatibility} hook}
 \footnotechanges{v0.2s}{1994/01/17}
         {Modify to reduce parameter stack usage}
 \footnotechanges{v0.2y}{1994/02/07}
         {Run \cs{@compatibility} on the first class to start
          (not the first to finish) }
 \footnotechanges{v0.2z}{1994/02/10}
         {Renamed \cs{@compatibility} to \cs{@documentclasshook}.
          ASAJ.}
 \footnotechanges{v1.1h}{2007/08/05}
         {Prevent loss of brackets PR/3965}
\begin{teX}
\def\@fileswith@pti@ns#1[#2]#3[#4]{%
  \ifx#1\@clsextension
    \ifx\@classoptionslist\relax
      \xdef\@classoptionslist{\zap@space#2 \@empty}%
      \def\reserved@a{%
        \@onefilewithoptions#3[{#2}][{#4}]#1%
        \@documentclasshook}%
    \else
      \def\reserved@a{%
        \@onefilewithoptions#3[{#2}][{#4}]#1}%
    \fi
  \else
\end{teX}
 build up a list of calls to |\@onefilewithoptions|
 (one for each package) without thrashing the parameter stack.
\begin{teX}
    \def\reserved@b##1,{%
      \ifx\@nil##1\relax\else
        \ifx\relax##1\relax\else
         \noexpand\@onefilewithoptions##1[{#2}][{#4}]%
         \noexpand\@pkgextension
        \fi
        \expandafter\reserved@b
      \fi}%
      \edef\reserved@a{\zap@space#3 \@empty}%
      \edef\reserved@a{\expandafter\reserved@b\reserved@a,\@nil,}%
  \fi
  \reserved@a}
\@onlypreamble\@fileswith@pti@ns
\end{teX}

 Have the main argument as |#1|, so we only need one |\expandafter|
 above.
 \footnotechanges{v0.2a}{1993/11/14}
         {Moved resetting of \cs{default@ds}, \cs{ds@} and
         \cs{@declaredoptions} here, from the end of
         \cs{ProcessOptions}.}
 \footnotechanges{v0.2f}{1993/11/22}
         {Made the initial version [] not [\cs{@unknownversion}]}
 \footnotechanges{v0.2m}{1993/12/07}
         {Reset \cs{CurrentOption}}
\begin{teX}
\def\@onefilewithoptions#1[#2][#3]#4{%
  \@pushfilename
  \xdef\@currname{#1}%
  \global\let\@currext#4%
  \expandafter\let\csname\@currname.\@currext-h@@k\endcsname\@empty
  \let\CurrentOption\@empty
  \@reset@ptions
  \makeatletter
\end{teX}
 Grab everything in a macro, so the parameter stack is popped before
 any processing begins.
 \footnotechanges{v0.2s}{1994/01/17}
         {Modify to reduce parameter stack usage}
 \footnotechanges{v1.1b}{1998/05/07}
         {Modify help message for latex/2805}
\begin{teX}
  \def\reserved@a{%
    \@ifl@aded\@currext{#1}%
      {\@if@ptions\@currext{#1}{#2}{}%
        {\@latex@error
            {Option clash for \@cls@pkg\space #1}%
            {The package #1 has already been loaded
             with options:\MessageBreak
             \space\space[\@ptionlist{#1.\@currext}]\MessageBreak
             There has now been an attempt to load it
              with options\MessageBreak
             \space\space[#2]\MessageBreak
             Adding the global options:\MessageBreak
             \space\space
                  \@ptionlist{#1.\@currext},#2\MessageBreak
             to your \noexpand\documentclass declaration may fix this.%
             \MessageBreak
             Try typing \space <return> \space to proceed.}}}%
      {\@pass@ptions\@currext{#2}{#1}%
\end{teX}
% \footnotechanges{v0.3c}{1994/03/12}
%         {Do not use \cs{@pr@videpackage} to avoid typeout}
\begin{teX}
       \global\expandafter
       \let\csname ver@\@currname.\@currext\endcsname\@empty
       \InputIfFileExists
         {\@currname.\@currext}%
         {}%
         {\@missingfileerror\@currname\@currext}%
\end{teX}
 |\@unprocessedoptions| will generate an error for each specified
 option in a package unless a |\ProcessOptions| has appeared in the
 package file.
% \footnotechanges{v0.2v}{1994/01/29}
%         {All options raise error if no \cs{ProcessOptions} appears}
% \footnotechanges{v0.2x}{1994/02/02}
%         {Only run the hook and options check if the file was loaded.}
\begin{teX}
    \let\@unprocessedoptions\@@unprocessedoptions
    \csname\@currname.\@currext-h@@k\endcsname
    \expandafter\let\csname\@currname.\@currext-h@@k\endcsname
              \@undefined
    \@unprocessedoptions}
\end{teX}
%
\begin{teX}
    \@ifl@ter\@currext{#1}{#3}{}%
      {\@latex@warning@no@line
         {You have requested,\on@line,
          version\MessageBreak
            `#3' of \@cls@pkg\space #1,\MessageBreak
          but only version\MessageBreak
           `\csname ver@#1.\@currext\endcsname'\MessageBreak
          is available}}%
\end{teX}
% \footnotechanges{v0.2c}{1993/11/17}
%         {Added trap for two \cs{LoadClass} commands.}
\begin{teX}
    \ifx\@currext\@clsextension\let\LoadClass\@twoloadclasserror\fi
    \@popfilename
    \@reset@ptions}%
  \reserved@a}
\@onlypreamble\@onefilewithoptions
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@@fileswith@pti@ns}{}
 Save the definition (for error checking).
 \footnotechanges{v0.2c}{1993/11/17}
         {Macro added}
\begin{teX}
\let\@@fileswith@pti@ns\@fileswith@pti@ns
\@onlypreamble\@@fileswith@pti@ns
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@reset@ptions}{}
 Reset the default option, and clear lists of declared options.
% \footnotechanges{v0.2a}{1993/11/14}{macro added}
\begin{teX}
\def\@reset@ptions{%
  \global\ifx\@currext\@clsextension
    \let\default@ds\OptionNotUsed
   \else
    \let\default@ds\@unknownoptionerror
  \fi
  \global\let\ds@\@empty
  \global\let\@declaredoptions\@empty}
\@onlypreamble\@reset@ptions
\end{teX}
\end{docCmd}

 \subsection{Hooks}

 Allow code do be saved to be executed at specific later times.

 Save things in macros, I considered using toks registers, (and
 |\addto@hook| from the NFSS code, that would require stacking the
 contents in the case of required packages, so just generate a new
 macro for each package.
 
\begin{docCmd}{@begindocumenthook}{}
% \footnotechanges{v1.0s}{1995/10/20}
%         {Make setting conditional, for autoload version}
\begin{docCmd}{@enddocumenthook}{}
 Stuff to appear at the beginning or end of the document.
\begin{teX}
\ifx\@begindocumenthook\@undefined
  \let\@begindocumenthook\@empty
\fi
\let\@enddocumenthook\@empty
\end{teX}
\end{docCmd}
\end{docCmd}
%
\begin{docCmd}{g@addto@macro}{}
 Globally add to the end of a macro.
% \footnotechanges{v0.2a}{1993/11/14}{Made global}
% \footnotechanges{v0.2w}{1994/01/31}
%     {Use toks register to avoid `hash' problems}
% \footnotechanges{v1.0o}{1995/05/17}
%     {Make long for latex/1522}
% \footnotechanges{v1.0w}{1996/12/17}
%     {Use \cs{begingroup} to save making a mathord}
% \footnotechanges{v1.0x}{1997/02/05}
%     {missing percent /2402}
\begin{teX}
\long\def\g@addto@macro#1#2{%
  \begingroup
    \toks@\expandafter{#1#2}%
    \xdef#1{\the\toks@}%
  \endgroup}
\end{teX}
\end{docCmd}
%
\begin{docCmd}{AtEndOfPackage}{}
\begin{docCmd}{AtEndOfClass}{}
\begin{docCmd}{AtBeginDocument}{}
\begin{docCmd}{AtEndDocument}{}
% The access functions.
% \footnotechanges{v0.2a}{1993/11/14}
%         {Included extension in the generated macro name for package
%         and class hooks.}
\begin{teX}
\def\AtEndOfPackage{%
  \expandafter\g@addto@macro\csname\@currname.\@currext-h@@k\endcsname}
\let\AtEndOfClass\AtEndOfPackage
\@onlypreamble\AtEndOfPackage
\@onlypreamble\AtEndOfClass
\end{teX}
%
\begin{teX}
\def\AtBeginDocument{\g@addto@macro\@begindocumenthook}
\def\AtEndDocument{\g@addto@macro\@enddocumenthook}
\@onlypreamble\AtBeginDocument
\end{teX}
\end{docCmd}
\end{docCmd}
\end{docCmd}
\end{docCmd}
%
%
\begin{docCmd}{@cls@pkg}{}
    The current file type.
% \footnotechanges{v0.2i}{1993/12/03}
         {Name changed to avoid clash with output routine.}
\begin{teX}
\def\@cls@pkg{%
  \ifx\@currext\@clsextension
    document class%
  \else
    package%
  \fi}
\@onlypreamble\@cls@pkg
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@unknownoptionerror}{}
 Bad option.
\begin{teX}
\def\@unknownoptionerror{%
  \@latex@error
    {Unknown option `\CurrentOption' for \@cls@pkg\space`\@currname'}%
    {The option `\CurrentOption' was not declared in
     \@cls@pkg\space`\@currname', perhaps you\MessageBreak
      misspelled its name.
     Try typing \space <return>
     \space to proceed.}}
\@onlypreamble\@unknownoptionerror
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@@unprocessedoptions}{}
% Declare an error for each option, unless a |\ProcessOptions| occurred.
% \footnotechanges{v0.2v}{1994/01/29}
%         {Macro added.}
% \footnotechanges{v1.0t}{1995/11/14}{Allow empty option}
\begin{teX}
\def\@@unprocessedoptions{%
  \ifx\@currext\@pkgextension
    \edef\@curroptions{\@ptionlist{\@currname.\@currext}}%
    \@for\CurrentOption:=\@curroptions\do{%
        \ifx\CurrentOption\@empty\else\@unknownoptionerror\fi}%
  \fi}
\@onlypreamble\@unprocessedoptions
\@onlypreamble\@@unprocessedoptions
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@badrequireerror}{}
% |\RequirePackage| or |\LoadClass| occurs in the options section.
% \footnotechanges{v0.2c}{1993/11/17}
%         {Macro added}
\begin{teX}
\def\@badrequireerror#1[#2]#3[#4]{%
  \@latex@error
    {\noexpand\RequirePackage or \noexpand\LoadClass
         in Options Section}%
    {The \@cls@pkg\space `\@currname' is defective.\MessageBreak
     It attempts to load `#3' in the options section, i.e.,\MessageBreak
     between \noexpand\DeclareOption and \string\ProcessOptions.}}
\@onlypreamble\@badrequireerror
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@twoloadclasserror}{}
 Two |\LoadClass| in a class.
% \footnotechanges{v0.2c}{1993/11/17}
%         {Macro added}
\begin{teX}
\def\@twoloadclasserror{%
  \@latex@error
    {Two \noexpand\LoadClass commands}%
    {You may only use one \noexpand\LoadClass in a class file}}
\@onlypreamble\@twoloadclasserror
\end{teX}
\end{docCmd}
%
\begin{docCmd}{@twoclasseserror}{}
 Two |\documentclass| or |\documentstyle|.
 \footnotechanges{v0.2h}{1993/11/28}
         {Macro added}
\begin{teX}
\def\@twoclasseserror#1#{%
  \@latex@error
    {Two \noexpand\documentclass or \noexpand\documentstyle commands}%
    {The document may only declare one class.}\@gobble}
\@onlypreamble\@twoclasseserror
\end{teX}
\end{docCmd}

\subsection{Providing shipment}
\begin{docCmd}{two@digits}{}
 Prefix a number less than 10 with `0'.
\begin{teX}
\def\two@digits#1{\ifnum#1<10 0\fi\number#1}
\end{teX}
\end{docCmd}


\begin{docCmd}{filecontents}{}
\begin{docCmd}{endfilecontents}{}
    This environment implements inline files.
    The star-form does not write extra comments into the file.
\footnotechanges{v0.2h}{1993/11/28}
         {Don't globally allocate a write stream (always use 15)}
\footnotechanges{v0.2r}{1993/12/19}{Different message when ignoring a file}
\footnotechanges{v0.3g}{1994/04/11}
         {Add star form,
          dont write \cs{endinput} at the end of the file.}
\footnotechanges{v1.0c}{1994/05/11}
         {Add checks for form feed and tab}
\footnotechanges{v1.0m}{1995/04/21}
         {Close input check stream: latex/1487}
\footnotechanges{v1.0p}{1995/05/25}{Delete \cs{filec@ntents} after preamble}
\begin{teX}
\begingroup%
\catcode`\*=11 %
\catcode`\^^M\active%
\catcode`\^^L\active\let^^L\relax%
\catcode`\^^I\active%
\end{teX}
%
\begin{teX}
\gdef\filecontents{\@tempswatrue\filec@ntents}%
\gdef\filecontents*{\@tempswafalse\filec@ntents}%
\end{teX}
%
\begin{teX}
\gdef\filec@ntents#1{%
  \openin\@inputcheck#1 %
  \ifeof\@inputcheck%
    \@latex@warning@no@line%
        {Writing file `\@currdir#1'}%
\end{teX}
%
% \footnotechanges{v1.0y}{1997/10/10}
%         {\cs{reserved@c} not \cs{verbatim@out} to save a csname}
\begin{teX}
    \chardef\reserved@c15 %
    \ch@ck7\reserved@c\write%
    \immediate\openout\reserved@c#1\relax%
  \else%
\end{teX}
%
% \footnotechanges{v1.0y}{1997/10/10}
%         {Use \cs{@gobbletwo}}
\begin{teX}
    \closein\@inputcheck%
    \@latex@warning@no@line%
            {File `#1' already exists on the system.\MessageBreak%
             Not generating it from this source}%
    \let\write\@gobbletwo%
    \let\closeout\@gobble%
  \fi%
  \if@tempswa%
\end{teX}

 \footnotechanges{v1.0y}{1997/10/10}
         {\cs{@currenvir} in banner}
\begin{teX}
    \immediate\write\reserved@c{%
      \@percentchar\@percentchar\space%
          \expandafter\@gobble\string\LaTeX2e file `#1'^^J%
      \@percentchar\@percentchar\space  generated by the %
        `\@currenvir' \expandafter\@gobblefour\string\newenvironment^^J%
      \@percentchar\@percentchar\space from source `\jobname' on %
         \number\year/\two@digits\month/\two@digits\day.^^J%
      \@percentchar\@percentchar}%
  \fi%
  \let\do\@makeother\dospecials%
\end{teX}

\footnotechanges{v1.0y}{1997/10/10}
     {Check for text before or after \cs{end} environment. latex/2636}
\begin{teX}
  \edef\E{\@backslashchar end\string{\@currenvir\string}}%
  \edef\reserved@b{%
    \def\noexpand\reserved@b%
         ####1\E####2\E####3\relax}%
  \reserved@b{%
    \ifx\relax##3\relax%
\end{teX}
 There was no |\end{filecontents}|
\begin{teX}
      \immediate\write\reserved@c{##1}%
    \else%
\end{teX}
 There was a |\end{filecontents}|, so stop this time.
\begin{teX}
      \edef^^M{\noexpand\end{\@currenvir}}%
      \ifx\relax##1\relax%
      \else%
\end{teX}
 Text before the |\end|, write it with a warning.
\begin{teX}
          \@latex@warning{Writing text `##1' before %
             \string\end{\@currenvir}\MessageBreak as last line of #1}%
        \immediate\write\reserved@c{##1}%
      \fi%
      \ifx\relax##2\relax%
      \else%
\end{teX}
 Text after the |\end|, ignore it with a warning.
\begin{teX}
         \@latex@warning{%
           Ignoring text `##2' after \string\end{\@currenvir}}%
      \fi%
    \fi%
    ^^M}%
\end{teX}

\begin{teX}
  \catcode`\^^L\active%
  \let\L\@undefined%
  \def^^L{\@ifundefined L^^J^^J^^J}%
  \catcode`\^^I\active%
  \let\I\@undefined%
  \def^^I{\@ifundefined I\space\space}%
  \catcode`\^^M\active%
  \edef^^M##1^^M{%
    \noexpand\reserved@b##1\E\E\relax}}%
\endgroup%
\end{teX}
%
\begin{teX}
\begingroup
\catcode`|=\catcode`\%
\catcode`\%=12
\catcode`\*=11
\gdef\@percentchar{%}
\gdef\endfilecontents{|
  \immediate\closeout\reserved@c
  \def\T##1##2##3{|
  \ifx##1\@undefined\else
    \@latex@warning@no@line{##2 has been converted to Blank ##3e}|
  \fi}|
  \T\L{Form Feed}{Lin}|
  \T\I{Tab}{Spac}|
  \immediate\write\@unused{}}
\global\let\endfilecontents*\endfilecontents
\@onlypreamble\filecontents
\@onlypreamble\endfilecontents
\@onlypreamble\filecontents*
\@onlypreamble\endfilecontents*
\endgroup
\@onlypreamble\filec@ntents
\end{teX}
\end{docCmd}
\end{docCmd}
%
%
% \footnotechanges{v0.2f}{1993/11/22}
%         {\cs{@unknownversion} removed}
% \footnotechanges{v1.0j}{1994/10/18}
%         {Move \cs{listfiles} to ltfiles.dtx}
%
\begin{teX}
%</2ekernel>
\end{teX}

 \section{After Preamble}
 Finally we declare a package that allows all the commands declared
 above to be |\@onlypreamble| to be used after |\begin{document}|.
% \footnotechanges{v0.3f}{1994/03/16}
%         {Add pkgindoc package}
% \footnotechanges{v1.1a}{1998/03/21}
%         {Correct to new onlypreamble command list}
\begin{teX}
%<*afterpreamble>
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pkgindoc}
         [1994/10/20 v1.1 Package Interface in Document (DPC)]
\def\reserved@a#1\do\@classoptionslist#2\do\filec@ntents#3\relax{%
  \gdef\@preamblecmds{#1#3}}
\expandafter\reserved@a\@preamblecmds\relax
%</afterpreamble>
\end{teX}
%
% \Finale
